<title>元数据视图管理</title>

  <style>
    .addColor{background: rgba(218, 250, 162, 1)}
    .left-list .layui-form-label{padding: 0px; width: auto;}
    .left-list .layui-input-block { margin-left: 28px;}
    .left-list .layui-form-item .layui-form-checkbox[lay-skin=primary] {  margin-top: 5px;}
    .left-list .active{background:rgba(218, 250, 162, 1)}
    .left-list .active2{background:rgba(218, 250, 162, 1)}
    .left-list .layui-card-body{padding:10px 0;height: 85%;}
    .left-list .layui-form-item{padding:8px 15px;margin-bottom: 0px;cursor: pointer;}
    .left-list .layui-btn-container{padding-left:25px;}
  </style>

<div class="layui-card layadmin-header">
  <div class="layui-breadcrumb" lay-filter="breadcrumb">
    <a lay-href="">主页</a>
    <a><cite>应用</cite></a>
    <a><cite>分类管理</cite></a>
  </div>
</div>

<div class="layui-fluid">
  <div class="layui-row layui-col-space12 h100">
    <div class="layui-col-md3 left-list h100" style="width: 23%;">
      <div class="layui-card h100">
        <div class="layui-card-header">视图</div>
        <div class="layui-card-body">
          <div class="layui-btn-container">
            <!--
                        <button type="button" class="layui-btn layui-btn-sm" data-type="add"><i class="layui-icon">&#xe608;</i> 新建</button>
            -->
            <button type="button" class="layui-btn layui-btn-sm" data-type="edit"><i class="layui-icon">&#xe642;</i> 修改</button>
            <button type="button" class="layui-btn layui-btn-sm" data-type="del"><i class="layui-icon">&#xe640;</i> 删除</button>
            <button type="button" class="layui-btn layui-btn-sm" data-type="delCodes"><i class="layui-icon">&#xe640;</i> 删除java代码及应用</button>
            <!--<select class="layui-btn layui-btn-sm">
              <option value="" selected>更多操作</option>
              <option value="" >导入</option>
              <option value="" >导出</option>
              <option value="" >设置同步规则</option>
              <option value="" >分配到栏目</option>
            </select>-->
          </div>
          <form class="layui-form" action="" id="listForm" style='position: relative;'>
          </form>
        </div>
        <div class="" id="pageleft" style="padding-left: 10px"></div>
      </div>
    </div>
    <div class="layui-col-md9 h100" style="width: 77%">
      <div class="layui-card h100">
        <div class="layui-card-header">视图字段</div>
        <div class="layui-card-body">
          <div class="layui-btn-container">
            <!--<button type="button" class="layui-btn layui-btn-sm layui-btn-primary" data-type="editField">维护字段</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary">维护分组</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary">维护字段表现</button>-->
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" data-type="delFields">删除字段</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" data-type="createCodes">生成java代码应用</button>
            <!--<button type="button" class="layui-btn layui-btn-sm layui-btn-primary">调整顺序</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary">设为标题</button>-->
            <!--
                        <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" data-type="publishJson">发布JSON串</button>
            -->
            <!--<button type="button" class="layui-btn layui-btn-sm layui-btn-primary">分组管理</button>-->
            <!--<button type="button" class="layui-btn layui-btn-sm layui-btn-primary">上传代码</button>-->
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" data-type="editViewSql">SQL语句视图修改</button>
          </div>
          <table class="layui-hide" id="fieldTabel"></table>
        </div>
      </div>
    </div>
  </div>
  <form action="" class="layui-form" id="form1" style="display: none">
    <div class="layui-card">
      <div class="layui-card-body">
        <div class="layui-form-item">
          <div class="layui-input-block" style="margin: 20px 0 20px 20px; width: 80px; display: inline-block; height: 32px!important">
            <select name="city" lay-verify="required">
              <option value="">全部</option>
            </select>
          </div>
          <div class="layui-input-block" style="margin: 20px -5px; width: 200px; display: inline-block;">
            <input type="text" required lay-verify="required" placeholder="请输入检索词" autocomplete="off" class="layui-input">
          </div>
          <div class="layui-input-block" style="margin: 20px 0px; display: inline-block;">
            <button class="layui-btn"><i class="layui-icon layui-icon-search"></i></button>
          </div>
          <span style="font-size: 12px;float:right;margin: 40px 20px 0 0">共<span style="color: red">1</span>页,<span style="color: red">43</span>个模块</span>
        </div>
        <div class="layui-form-item" style="margin: 20px; border: 1px solid #ccc; height: 200px!important; overflow:auto">
          <div class="layui-input-block" style="margin: 7px; width: 200px; display: inline-block; height: 32px!important">
            <input type="radio" name="sex"> <span>通用概览_标准化概况</span>
          </div>
          <div class="layui-input-block" style="margin: 7px; width: 200px; display: inline-block; height: 32px!important">
            <input type="radio" name="sex"><span>通用概览_标准化概况</span>
          </div>
          <div class="layui-input-block" style="margin: 7px; width: 200px; display: inline-block; height: 32px!important">
            <input type="radio" name="sex"><span>通用概览_标准化概况</span>
          </div>
        </div>
        <div class="layui-form-item">
          <div class="layui-input-block" style="margin-left: 135px;">
            <button class="layui-btn" lay-submit lay-filter="formDemo">确定</button>
            <button type="reset" class="layui-btn layui-btn-primary">取消</button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<!--弹出层模板（新增，查看，编辑）-->
<script type="text/html"  id="metadataTemplate">
  <form class="layui-form" lay-filter="metadataForm">
    <div class="layui-card">
      <div class="layui-card-body">
        {{# if(!d.edit){ }}
        <div class="layui-form-item">
        <label class="layui-form-label">表英文前缀:</label>
        <div class="layui-input-block">
        <input type="text" name="preTbm" value="" placeholder="请输入" autocomplete="off" class="layui-input">
        </div>
        </div>
        {{# } }}
        <div class="layui-form-item">
          <label class="layui-form-label">*表英文名称:</label>
          <div class="layui-input-block">
            <input type="text" name="viewname" value="" required lay-verify="required"  {{ d.edit?'readonly':'' }} placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">*表主键字段:</label>
          <div class="layui-input-block">
            <input type="text" name="pk" value="" required lay-verify="required"  placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">*表中文名称:</label>
          <div class="layui-input-block">
            <input type="text" name="tableviewname" value="" required lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">视图描述:</label>
          <div class="layui-input-block">
            <input type="text" name="viewdesc" value="" required lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">元数据模板:</label>
          <div class="layui-input-block" style="height: 30px;padding-top: 10px;cursor: pointer;">
            <i class="layui-icon layui-icon-app" data-method="select" id="select"></i>
            请选择模板
          </div>
        </div>
        <div class="layui-form-item">
          <div class="layui-input-block" style="margin-left: 135px;">
            <button class="layui-btn" lay-submit lay-filter="addMetadata">确认</button>
            <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll();">取消</button>
          </div>
        </div>
      </div>
    </div>
    <input type="hidden" name="id">
  </form>
</script>
<!--弹出层模板（新增，查看，编辑）-->
<script type="text/html"  id="fieldTemplate">
  <form class="layui-form" lay-filter="fieldForm">
    <div class="layui-card">
      <div class="layui-card-body">
        <div class="layui-form-item">
          <label class="layui-form-label">视图名</label>
          <div class="layui-input-block">
            <input type="text"  placeholder="" value="{{d.viewname?d.viewname:''}}" readonly name="viewname" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">中文名称</label>
          <div class="layui-input-block">
            <input type="text" name="anothername" value="{{d.anothername?d.anothername:''}}" class="layui-input" required lay-verify="required">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">英文名称</label>
          <div class="layui-input-block">
            <input type="text" name="fieldname" value="{{d.fieldname?d.fieldname:''}}" class="layui-input" required lay-verify="required">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">字段类型</label>
          <div class="layui-input-block">
            <select name="fieldtype" id="fieldtype" value="{{d.fieldtype?d.fieldtype:''}}" class="layui-input" required lay-verify="required">
              <option>--请选择--</option>
            </select>
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">库中类型</label>
          <div class="layui-input-block">
            <select name="dbtype" id="dbtype" value="{{d.dbtype?d.dbtype:''}}" class="layui-input" required lay-verify="required">
              <option>--请选择--</option>
            </select>
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">库中长度</label>
          <div class="layui-input-block">
            <input type="text" name="dblength" value="{{d.dblength?d.dblength:''}}" class="layui-input" required lay-verify="required">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">选择分组</label>
          <div class="layui-input-block">
            <input type="text" name="groupid" value="{{d.groupid?d.groupid:''}}" class="layui-input" required lay-verify="required">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">是否启用</label>
          <div class="layui-input-block">
            <input type="text" name="hiddenfield" value="{{d.hiddenfield?d.hiddenfield:''}}" class="layui-input" required lay-verify="required">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">字段默认值</label>
          <div class="layui-input-block">
            <input type="text" name="defaultvalue" value="{{d.defaultvalue?d.defaultvalue:''}}" class="layui-input" required lay-verify="required">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">是否非空</label>
          <div class="layui-input-block">
            <input type="text" name="notnull" value="{{d.notnull?d.notnull:''}}" class="layui-input" required lay-verify="required">
          </div>
        </div>
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button class="layui-btn" lay-submit="" lay-filter="addFieldinfo">立即提交</button>
            <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll();">关闭</button>
          </div>
        </div>
      </div>
    </div>
    <input type="hidden" name="tableid" value="{{d.tableid?d.tableid:''}}" id="tableid">
    <input type="hidden" name="id" value="{{d.id?d.id:''}}">
  </form>
</script>

<script type="text/html"  id="viewsqlTemplate">
  <form class="layui-form" lay-filter="viewsqlForm">
    <div class="layui-card">
      <div class="layui-card-body">
        <div class="layui-form-item">
          <label class="layui-form-label">*表英文名称:</label>
          <div class="layui-input-block">
            <input type="text" name="viewname" value="" required lay-verify="required" {{ d.edit?'readonly':'' }} placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">*表主键字段:</label>
          <div class="layui-input-block">
            <input type="text" name="pk" value="" required lay-verify="required" {{ d.edit?'readonly':'' }} placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">*表中文名称:</label>
          <div class="layui-input-block">
            <input type="text" name="tableviewname" value="" required lay-verify="required" {{ d.edit?'readonly':'' }} placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <!--<div class="layui-form-item">
          <label class="layui-form-label">sql语句修改:</label>
          <div class="layui-input-block">
            <input type="text" name="viewsql" value="" required lay-verify="required" {{ d.edit?'readonly':'' }} placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>-->
        <div class="layui-form-item layui-form-text">
          <label class="layui-form-label">sql语句修改:</label>
          <div class="layui-input-block">
            <textarea name="viewsql" placeholder="请输入内容" class="layui-textarea" autocomplete="off" required lay-verify="required" {{ d.edit?'readonly':'' }} ></textarea>
          </div>
        </div>
        <div class="layui-form-item">
          <div class="layui-input-block" style="margin-left: 135px;">
            <button class="layui-btn" lay-submit lay-filter="addViewsql">确认</button>
            <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll();">取消</button>
          </div>
        </div>
      </div>
    </div>
    <input type="hidden" name="id">
  </form>
</script>

<script type="text/html" id="state">
  <a>{{d.generatestate == 1 ? "是" : "否"}}</a>
</script>

<script>
  // layui
  layui.use('table', function(){
      var $ = layui.$
          ,layer = layui.layer
          ,table = layui.table
          ,form = layui.form;

      form.on('submit(addMetadata)', function(data){
          if(data.field.id){
            doEditMetadata(data.field);
          }else{
            doAddMetadata(data.field);
          }
          return false;
      });
      form.on('submit(addFieldinfo)', function(data){
          if(data.field.id){
            doEditField(data.field);
          }else{
            doAddField(data.field);
        }
          return false;
      });
    form.on('submit(addViewsql)', function(data){
      doEditViewsql(data.field);
      return false;
    });
  });

  function doEditViewsql(data){
    ajax("/metadata/view/"+data.id,"put",JSON.stringify(data)).then(res=>{
      console.log(data);
      ajax2("/metadata/view/getViewSql","post",{sql:data.viewsql}).then(res2=>{
        console.log(res2);
        layer.alter(res2.msg);
      })
      if(res.success){
//        layer.alert("修改成功",function(index){
        layer.closeAll();
        getMetadatas(1);
//        });
      }else{
        layer.alert(res.msg,function(){
          layer.closeAll();
        });
      }
    }).catch(res=>{

    })
  }
  active.delFields = function(){
    doDeleteFields();
  };
  active.createCodes = function(){
    var tableName = metadataObj.name;
    if(!tableName){
      layer.alert("请选择表");
      return false;
    }
    var params = {};
    params.tableNames = tableName;
    if(tableName.indexOf("_")>0){
      params.prefixes = tableName.split("_")[0] + "_";
    }
    ajax2("/generator/createCode","post",params).then(res => {
      if(res.success){
        layer.alert("生成成功!");
        ajax2("/generator/mvnPackage","post",{}).then(res2 => {
          if(res2.success){
            layer.alert("发布成功!");
            var data = checkChecked('fieldTabel');
            ajax("/metadata/viewfield/updateViewState","post",metadataObj.id).then(res3=>{
              if(res3.success){
                layer.alert("状态信息更新完毕!");
                getFields(metadataObj.id);
              }else {
                layer.alert(res3.msg);
              }
            });
          }else{
            layer.alert(res2.msg);
          }
        })
      }else{
        layer.alert(res.msg);
      }
    })
  }

  active.delCodes = function(){
    var tableName = metadataObj.name;
    if(!tableName){
      layer.alert("请选择表");
      return false;
    }
    var params = {};
    params.tableNames = tableName;
    if(tableName.indexOf("_")>0){
      params.prefixes = tableName.split("_")[0] + "_";
    }
    layer.open({
      content: "确认删除应用吗？"
      ,btn: ['确认',"取消"]
      ,yes: function(index, layero){
        ajax2("/generator/delCodes","post",params).then(res => {
          if(res.success){
            layer.alert("删除成功");
            var data = checkChecked('fieldTabel');
            ajax("/metadata/viewfield/deleteViewState","post", metadataObj.id).then(res3=>{
              if(res3.success){
                layer.alert("状态信息更新完毕!");
                getFields(metadataObj.id);
              }else {
                layer.alert(res3.msg);
              }
            });
          }else{
            layer.alert(res.msg);
          }
        }).catch(res=>{

        })
      }
      ,btn2: function(index, layero){
        layer.closeAll();
      }
    });

  }
  active.setTop = function () {
    layer.open({
      type: 1,
      title: "新建字段",
      area: ['550px', '670px'],
      shade: 0,
      maxmin: true,
      content: '<div id="fieldForm"></div>',
      cancel: function(){

      }
    });
    layui.laytpl($("#fieldTemplate").html()).render({tableid:metadataObj.id,tablename:metadataObj.name}, function(html){
      $("#fieldForm").html(html)
      getDict();
      getDbDict();
    });
  };
  active.editField = function (){
    editField();
  };

  layui.use('layer', function() { //独立版的layer无需执行这一句
    var $ = layui.jquery, layer = layui.layer; //独立版的layer无需执行这一句

    layui.use(['form'], function () {
      var form = layui.form
              , layer = layui.layer
    })
    layui.use('layer', function () { //独立版的layer无需执行这一句
      var $ = layui.jquery, layer = layui.layer; //独立版的layer无需执行这一句

      $('#select').on('click', select);

      function select() {
        var that = this;
        layer.open({
          type: 1,
          title: "选择模板",
          area: ['542px', '409px'],
          shade: 0,
          maxmin: true,
          content: $("#form1")
        });
      }
    })
  })
</script>

<script>
  var metadataObj = {};
  function editField(){
    if(checkChecked('fieldTabel')){
      var data = getTableCheck("fieldTabel");
      //console.log(data)
      layer.open({
        type: 1,
        title: "维护视图字段",
        area: ['550px', '670px'],
        shade: 0,
        maxmin: true,
        content: '<div id="fieldForm"></div>'
      });
      layui.laytpl($("#fieldTemplate").html()).render(data[0], function(html){
        $("#fieldForm").html(html)
        getDict(data[0].fieldtype);
        getDbDict(data[0].dbtype);
      });
    }
  }
  function doDeleteFields(){
    var data = checkChecked('fieldTabel');
    if(data) {
      layer.open({
        content: "确认删除该字段吗？"
        ,btn: ['确认',"取消"]
        ,yes: function(index, layero){
          ajax("/metadata/viewfield/delByIds","POST",JSON.stringify(data)).then(res=>{
            if (res.success) {
//          res.msgConfig = "删除成功";
              getFields(metadataObj.id);
              layer.closeAll();
            }else{
              layer.alert("删除失败");
            }
          }).catch(res=>{

          })
        }
        ,btn2: function(index, layero){
          layer.closeAll();
        }
      });

    }
  }
  function checkChoice(){
    if(!metadataObj.id){
      layer.alert("请选择菜单");
      return false;
    }
    return true;
  }
  function doAddField(data){
    var metadataid = data.tableid;
    ajax("/metadata/fieldinfo/add","POST",JSON.stringify(data)).then(res=>{
      if(res.success){
          getFields(metadataid);
          layer.closeAll();
      }else{
        layer.alert(res.msg,function(){
          layer.closeAll();
        });
      }
    }).catch(res=>{

    })
  }
  function doEditField(data){
    var metadataid = data.tableid;
    ajax("/metadata/viewfield/"+data.id,"put",JSON.stringify(data)).then(res=>{
      if(res.success){
//        layer.alert("修改成功",function(index){
          getFields(metadataid);
          layer.closeAll();
//        });
      }else{
        layer.alert(res.msg,function(){
          layer.closeAll();
        });
      }
    }).catch(res=>{

    })
  }
  function doAddMetadata(data){
     data.viewname = data.preTbm+data.viewname;
    ajax("/metadata/view/add","post",JSON.stringify(data)).then(res=>{
      if(res.success){
//        layer.alert("新建成功",function(index){
          layer.closeAll();
          getMetadatas(1);
//        });
      }else{
        layer.alert(res.msg,function(){
          layer.closeAll();
        });
      }
    }).catch(res=>{

    })
  }
  function doEditMetadata(data){
    ajax("/metadata/view/"+data.id,"put",JSON.stringify(data)).then(res=>{
      if(res.success){
//        layer.alert("修改成功",function(index){
          layer.closeAll();
          getMetadatas(1);
//        });
      }else{
        layer.alert(res.msg,function(){
          layer.closeAll();
        });
      }
    }).catch(res=>{

    })
  }
  function getMetadatas(pageNo){
    var jsondata = {
      "pager": {
        "current": pageNo,
        "size": 10
      }
    }
    ajax("/metadata/view/list","post",JSON.stringify(jsondata)).then(data=>{
      if(data.success){
        if(data.obj.records.length>0){
          getFields(data.obj.records[0].id);
          metadataObj.id = data.obj.records[0].id;
          metadataObj.name = data.obj.records[0].tablename;
        }
        var html = "";
        for(var i in data.obj.records){
          var obj = data.obj.records[i];
          var activeClass = "";
          if(i == 0) {
            activeClass = "active";
          }
          html += '<div class="layui-form-item '+activeClass+'" data_id="'+obj.id+'" data_name="'+obj.tablename+'" pane="">' +
                  '              <div class="layui-form-label"><input type="checkbox" name="listid" value="'+obj.id+'" lay-skin="primary"></div>' +
                  '              <div class="layui-input-block">' +
                  '                <p>'+obj.tableviewname+' ['+obj.viewname+']</p>' +
                  '                <p>创建时间:'+obj.crtime+'</p>' +
                  '              </div>' +
                  '            </div>';
        }
        $("#listForm").html(html);

        var laypage = layui.laypage
                ,layer = layui.layer;

        layui.use(['laypage', 'layer'], function(){
          laypage.render({
            elem: 'pageleft'
            ,count: data.obj.total //数据总数
            ,curr:data.obj.current
            ,jump: function(obj,first){
              if(!first){
                getMetadatas(obj.curr)
              }
            }
          });
        });

        layui.form.render();
      }
    }).catch(res=>{

    })
  }
  function getDict(val){
    ajax("/metadata/dict/list","post",JSON.stringify("field_type")).then(data=>{
      for(var i in data){
        if(val && val == data[i].no){
          $("#fieldtype").append("<option selected value='"+data[i].no+"'>"+data[i].name+"</option>")
        }else{
          $("#fieldtype").append("<option value='"+data[i].no+"'>"+data[i].name+"</option>")
        }
      }
      layui.form.render('select');
    }).catch(res=>{

    })
  }

  function getDbDict(val){
    ajax("/metadata/dict/list","post",JSON.stringify("db_type")).then(data=>{
      for(var i in data){
        if(val && val == data[i].no) {
          $("#dbtype").append("<option selected value='" + data[i].no + "'>" + data[i].name + "</option>")
        }else{
          $("#dbtype").append("<option value='" + data[i].no + "'>" + data[i].name + "</option>")
        }
      }
      layui.form.render('select');
    }).catch(res=>{

    })
  }
  function getFields(id){
    var jsondata = {
      "entity": {
        "viewid": id
      },
      "pager": {
        "current": 1,
        "size": 10
      }
    }
    ajax("/metadata/viewfield/list","post",JSON.stringify(jsondata)).then(data=>{
      layui.use('table', function(){
        var table = layui.table;
        table.render({
          elem: '#fieldTabel'
          ,data:data.obj.records
          ,cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
          ,cols: [[
            {type:'checkbox'}
            ,{type:'numbers',title: '序号'}
            ,{field:'fieldname',  title: '英文名称'}
            ,{field:'anothername', title: '中文名称', sort: true}
            ,{field:'fieldTypeStr', title: '字段类型', minWidth: 100} //minWidth：局部定义当前单元格的最小宽度，layui 2.2.1 新增
            ,{field:'dbTypeStr', title: '库中类型', sort: true}
            ,{field:'groupname', title: '所属分组'}
            ,{field:'generatestate',  title: '是否生成java代码应用', sort: true, templet: "#state"}
            ,{field:'generatetime',  title: '生成时间', sort: true}
          ]]
        });
        console.log(data.obj.records);
      });
    }).catch(res=>{

    })
  }
  function del(){
    var ids = [];
    $("input[name='listid']:checked").each(function(){
      ids.push($(this).val());
    })
    if(ids.length<=0){
      layer.alert("请选择视图");
      return false;
    }
    layer.open({
      content: "确认删除该视图吗？"
      ,btn: ['确认',"取消"]
      ,yes: function(index, layero){
        ajax("/metadata/view/delByIds","post",JSON.stringify(ids)).then(data=>{
          if(data.success){
            getMetadatas(1);
            getFields(metadataObj.id);
            layer.closeAll()
          }else{
            layer.alert(data.msg);
          }
        }).catch(res=>{

        })
      }
      ,btn2: function(index, layero){
        layer.closeAll();
      }
    });
  }
  function add(){
    //多窗口模式，层叠置顶
    layer.open({
      type: 1,
      title: "新建视图",
      area: ['600px', '450px'],
      shade: 0,
      maxmin: true,
      content: '<div id="addMetadataForm"></div>',
    });
    layui.laytpl($("#metadataTemplate").html()).render({edit:false}, function(html){
      $("#addMetadataForm").html(html)
    });
    layui.form.val("metadataForm",{preTbm:"VIEW_"});
  }
  function edit(){
    if(checkChoice()){
      ajax("/metadata/view/"+metadataObj.id,"get",{}).then(data=>{
        console.log(data);
        layer.open({
          type: 1,
          title: "修改视图",
          area: ['600px', '450px'],
          shade: 0,
          maxmin: true,
          content: '<div id="addMetadataForm"></div>',
        });
        layui.laytpl($("#metadataTemplate").html()).render({edit:true}, function(html){
          $("#addMetadataForm").html(html)
        });
        layui.form.val("metadataForm",data.obj);
      }).catch(res=>{

      })
    }
  }
  active.editViewSql = function(){
    editViewsql2();
  };
  function editViewsql2(){
    if(checkChoice()){
      ajax("/metadata/view/viewSql","post",JSON.stringify(metadataObj.id)).then(data=>{
        console.log(data);
        layer.open({
          type: 1,
          title: "修改视图",
          area: ['600px', '450px'],
          shade: 0,
          maxmin: true,
          content: '<div id="addviewsqlForm"></div>',
        });
        layui.laytpl($("#viewsqlTemplate").html()).render({edit:false}, function(html){
          $("#addviewsqlForm").html(html)
        });

        var viewsql = "CREATE OR REPLACE VIEW "+data.obj.viewname+" AS "+data.obj.sql;
        layui.form.val("viewsqlForm",data.obj);
        layui.form.val("viewsqlForm",{viewsql: viewsql});
      }).catch(res=>{

      })
    }
  }
</script>

<script>
  $(function(){
    $(".left-list").on("mouseover",".layui-form-item",function(){
      $(this).addClass("active2").siblings().removeClass("active2");
    })
    $(".left-list").on("mouseleave",".layui-form-item",function(){
      $(this).removeClass("active2");
    })
    $(".left-list").on("click",".layui-input-block",function(){
      $(".left-list input").prop("checked",false);
      $(this).parent().find("input").prop("checked",true);
      layui.form.render();
      $(this).parent().addClass("active").siblings().removeClass("active");
      metadataObj.id = $(this).attr("data_id");
      metadataObj.name = $(this).attr("data_name");
      getFields($(this).attr("data_id"));
    })
    layui.form.render();
    getMetadatas(1);
  })

</script>