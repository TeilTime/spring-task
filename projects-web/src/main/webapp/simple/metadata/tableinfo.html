﻿﻿<title>元数据设计</title>

  <style>
    .addColor{background: rgba(218, 250, 162, 1)}
    .left-list .layui-form-label{padding: 0px; width: auto;}
    .left-list .layui-input-block { margin-left: 28px;}
    .left-list .layui-form-item .layui-form-checkbox[lay-skin=primary] {  margin-top: 5px;}
    .left-list .active{background:rgba(218, 250, 162, 1)}
    .left-list .active2{background:rgba(218, 250, 162, 1)}
    .left-list .layui-card-body{padding:10px 0;height: 85%;}
    .left-list .layui-form-item{padding:8px 15px;margin-bottom: 0px;cursor: pointer;}
    .left-list .layui-btn-container{padding-left:25px;}
  </style>

<div class="layui-card layadmin-header">
  <div class="layui-breadcrumb" lay-filter="breadcrumb">
    <a lay-href="">主页</a>
    <a><cite>应用</cite></a>
    <a><cite>分类管理</cite></a>
  </div>
</div>
<div class="layui-fluid">
  <div class="layui-row layui-col-space12 h100">
    <div class="layui-col-md3 left-list h100" style="width: 23%;">
      <div class="layui-card h100">
        <div class="layui-card-header">元数据</div>
        <div class="layui-card-body">
          <div class="layui-btn-container">
            <button type="button" class="layui-btn layui-btn-sm" data-type="add"><i class="layui-icon">&#xe608;</i> 新建</button>
            <button type="button" class="layui-btn layui-btn-sm" data-type="edit"><i class="layui-icon">&#xe642;</i> 修改</button>
            <button type="button" class="layui-btn layui-btn-sm" data-type="del"><i class="layui-icon">&#xe640;</i> 删除</button>
            <button type="button" class="layui-btn layui-btn-sm" data-type="delCodes"><i class="layui-icon">&#xe640;</i> 删除元数据及应用</button>
            <!--
                        <button type="button" class="layui-btn layui-btn-sm" onclick="create()"><i class="layui-icon">&#xe653;</i> 生成视图</button>
            -->
          </div>
          <form class="layui-form" action="" id="listForm" style='position: relative;'>
          </form>
        </div>
        <div class="" id="pageleft" style="padding-left: 10px"></div>
      </div>
    </div>
    <div class="layui-col-md9 h100" style="width: 77%">
      <div class="layui-card h100">
        <div class="layui-card-header">表字段</div>
        <div class="layui-card-body">
          <div class="layui-btn-container">
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" data-type="setTop" data-type="t">新建字段</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" data-type="editField">修改字段</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" data-type="delFields">删除字段</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" data-type="createCodes">生成java代码应用</button>
            <!--            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary">下载模板</button>
                        <button type="button" class="layui-btn layui-btn-sm layui-btn-primary">上传模板</button>-->
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary">导出表数据</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" data-type="sameCreate">类似创建</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" onclick="create()">生成视图</button>

          </div>
          <table class="layui-hide" id="fieldTabel"></table>
          <div id="fieldPage"></div>
        </div>
      </div>
    </div>
  </div>
  <form action="" class="layui-form" id="form1" style="display: none">
    <div class="layui-card">
      <div class="layui-card-body">
        <div class="layui-form-item">
          <div class="layui-input-block" style="margin: 20px 0 20px 20px; width: 80px; display: inline-block; height: 32px!important">
            <select name="city" lay-verify="required">
              <option value="">全部</option>
            </select>
          </div>
          <div class="layui-input-block" style="margin: 20px -5px; width: 200px; display: inline-block;">
            <input type="text" required lay-verify="required" placeholder="请输入检索词" autocomplete="off" class="layui-input">
          </div>
          <div class="layui-input-block" style="margin: 20px 0px; display: inline-block;">
            <button class="layui-btn"><i class="layui-icon layui-icon-search"></i></button>
          </div>
          <span style="font-size: 12px;float:right;margin: 40px 20px 0 0">共<span style="color: red">1</span>页,<span style="color: red">43</span>个模块</span>
        </div>
        <div class="layui-form-item" style="margin: 20px; border: 1px solid #ccc; height: 200px!important; overflow:auto">
          <div class="layui-input-block" style="margin: 7px; width: 200px; display: inline-block; height: 32px!important">
            <input type="radio" name="sex"> <span>通用概览_标准化概况</span>
          </div>
          <div class="layui-input-block" style="margin: 7px; width: 200px; display: inline-block; height: 32px!important">
            <input type="radio" name="sex"><span>通用概览_标准化概况</span>
          </div>
          <div class="layui-input-block" style="margin: 7px; width: 200px; display: inline-block; height: 32px!important">
            <input type="radio" name="sex"><span>通用概览_标准化概况</span>
          </div>
        </div>
        <div class="layui-form-item">
          <div class="layui-input-block" style="margin-left: 135px;">
            <button class="layui-btn" lay-submit lay-filter="formDemo">确定</button>
            <button type="reset" class="layui-btn layui-btn-primary">取消</button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
<!--视图命名弹出层-->
<script type="text/html"  id="viewTemplate">
  <form class="layui-form" lay-filter="viewForm">
    <div class="layui-card">
      <div class="layui-card-body">
        <div class="layui-form-item">
          <label class="layui-form-label">视图英文前缀:</label>
          <div class="layui-input-block">
            <input type="text" name="viewTbm" value="" placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">*视图名称:</label>
          <div class="layui-input-block">
            <input type="text" name="viewname" value="" required lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <div class="layui-input-block" style="margin-left: 135px;">
            <button class="layui-btn" lay-submit lay-filter="addView">确认</button>
            <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll();">取消</button>
          </div>
        </div>
      </div>
    </div>
    <input type="hidden" name="viewsf">
  </form>
</script>
<!--弹出层模板（新增，查看，编辑）-->
<script type="text/html"  id="metadataTemplate">
  <form class="layui-form" lay-filter="metadataForm">
    <div class="layui-card">
      <div class="layui-card-body">
        {{# if(!d.edit){ }}
          <div class="layui-form-item">
            <label class="layui-form-label">表英文前缀:</label>
            <div class="layui-input-block">
              <input type="text" name="preTbm" value="" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
          </div>
        {{# } }}
        <div class="layui-form-item">
          <label class="layui-form-label">*表英文名称:</label>
          <div class="layui-input-block">
            <input type="text" name="tablename" value="" required lay-verify="required"  {{ d.edit?'readonly':'' }} placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">*表主键字段:</label>
          <div class="layui-input-block">
            <input type="text" name="pk" value="" required lay-verify="required" {{ d.edit?'readonly':'' }} placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">*表中文名称:</label>
          <div class="layui-input-block">
            <input type="text" name="anothername" value="" required lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">*文档列表页:</label>
          <div class="layui-input-block">
            <input type="text" name="listjsp" value="" required lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">元数据模板:</label>
          <div class="layui-input-block" style="height: 30px;padding-top: 10px;cursor: pointer;">
            <i class="layui-icon layui-icon-app" onclick="selectTemp()" id="select"></i>
            请选择模板
          </div>
        </div>
        <div class="layui-form-item">
          <div class="layui-input-block" style="margin-left: 135px;">
            <button class="layui-btn" lay-submit lay-filter="addMetadata">确认</button>
            <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll();">取消</button>
          </div>
        </div>
      </div>
    </div>
    <input type="hidden" name="id">
    <input type="hidden" name="ownerid">
    <input type="hidden" id="modelId" name="modelfilename">
  </form>
</script>
<!--弹出层模板（新增，查看，编辑）-->
<script type="text/html"  id="fieldTemplate">
  <form class="layui-form" lay-filter="fieldForm">
    <div class="layui-card">
      <div class="layui-card-body">

          <div class="layui-form-item">
            <label class="layui-form-label">元数据表名</label>
            <div class="layui-input-block">
              <input type="text"  placeholder="" readonly name="tablename" autocomplete="off" class="layui-input">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">*中文名称</label>
            <div class="layui-input-block">
              <input type="text" name="anothername" class="layui-input" required lay-verify="required">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">*英文名称</label>
            <div class="layui-input-block">
              <input type="text" name="fieldname" class="layui-input" required lay-verify="required">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">字段类型</label>
            <div class="layui-input-block">
              <select name="fieldtype" id="fieldtype" class="layui-input" lay-filter="fieldType">
              </select>
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">库中类型</label>
            <div class="layui-input-block">
              <select name="dbtype" id="dbtype" class="layui-input" disabled="disabled">
              </select>
            </div>
          </div>

          <div class="layui-form-item" id="enum_tr" style="display:none;">
            <label class="layui-form-label">枚举值</label>
            <div class="layui-input-block">
              <input type="text" id="enumStr" name="enumStr" class="layui-input" maxlength="1000"/>
            </div>
          </div>

          <div class="layui-form-item" id="class_tr" style="display:none;">
            <label class="layui-form-label">分类法</label>
            <div class="layui-input-block">
              <select name="classId" id="classId" class="layui-input" maxlength="200">
              </select>
            </div>
          </div>

          <div class="layui-form-item" id="class_tr_2" style="display:none;">
            <label class="layui-form-label">选择类型：</label>
              多选：<input type="radio" id="classTypeMore" name="classType" value="1" checked/>
              单选：<input type="radio" id="classTypeOnly" name="classType" value="0"/>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">*库中长度</label>
            <div class="layui-input-block">
              <input type="text" id="dbLength" name="dblength" class="layui-input" required lay-verify="required">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">选择分组</label>
            <div class="layui-input-block">
              <select name="groupid" id="groupid" class="layui-input" required lay-verify="required">
                <option>--请选择--</option>
              </select>
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">是否启用</label>
            <div class="layui-input-block">
              <select name="hiddenfield" id="hiddenfield" class="layui-input" required lay-verify="required">
                <option value="0">是</option>
                <option value="1">否</option>
              </select>
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">*字段默认值</label>
            <div class="layui-input-block">
              <input type="text" name="defaultvalue" class="layui-input" required lay-verify="required">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">是否非空</label>
            <div class="layui-input-block">
              <select name="notnull" id="notnull" class="layui-input" required lay-verify="required">
                <option value="1">是</option>
                <option value="0">否</option>
              </select>
            </div>
          </div>

        <div class="layui-form-item">
          <div class="layui-input-block">
            <button class="layui-btn" lay-submit="" lay-filter="addFieldinfo">立即提交</button>
            <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll();">关闭</button>
          </div>
        </div>
      </div>
    </div>
    <input type="hidden" name="tableid" id="tableid">
    <input type="hidden" name="id">
  </form>
</script>

<!--选择元数据模板-->
<script type="text/html" id="tempContent">
  <div>
    {{# layui.each(d,function(index,item){   }}
    <div>
      <input type="radio" name="temp" value="{{item.id}}" >
      <label>{{item.tempname}}</label>
    </div>
    {{#})  }}
    <div class="layui-input-block" style="margin-left: 135px;">
      <button type="button" class="layui-btn" onclick="addTemp()">确定</button>
      <button type="button" class="layui-btn layui-btn-primary" onclick="layer.close();">取消</button>
    </div>
  </div>
</script>

<script type="text/html" id="state1">
  <a>{{d.generatestate == 1 ? "是" : "否"}}</a>
</script>

<script>
  // layui
  layui.use('table', function(){
      var $ = layui.$
          ,layer = layui.layer
          ,table = layui.table
          ,form = layui.form;

      form.on('submit(addMetadata)', function(data){
          if(data.field.id){
            doEditMetadata(data.field);
          }else{
            doAddMetadata(data.field);
          }
          return false;
      });
      form.on('submit(addFieldinfo)', function(data){
        console.log(data);
          if(data.field.id){
            doEditField(data.field);
          }else{
            doAddField(data.field);
        }
          return false;
      });
      form.on('submit(addView)', function(data){
        doAddView(data.field);
        return false;
      });
  });
  /*active.addView = function(data){
    doAddView(data.field);
  };*/
  active.createCodes = function(){
    var tableName = metadataObj.name;
    if(!tableName){
      layer.alert("请选择表");
      return false;
    }
    var params = {};
    params.tableNames = tableName;
    if(tableName.indexOf("_")>0){
      params.prefixes = tableName.split("_")[0] + "_";
    }
    ajax2("/generator/createCode","post",params).then(res => {
      if(res.success){
        layer.alert("生成成功!");
        ajax2("/generator/mvnPackage","post",{}).then(res2 => {
          if(res2.success){
            layer.alert("发布成功!");
            ajax("/metadata/fieldinfo/updateState","post",metadataObj.id).then(res3=>{
              if(res3.success){
                layer.alert("状态信息更新完毕!");
                getFields(metadataObj.id);
              }else {
                layer.alert(res3.msg);
              }
            });
          }else{
            layer.alert(res2.msg);
          }
        })
      }else{
        layer.alert(res.msg);
      }
    })
  }
  active.delCodes = function(){
    var tableName = metadataObj.name;
    if(!tableName){
      layer.alert("请选择表");
      return false;
    }
    var params = {};
    params.tableNames = tableName;
    if(tableName.indexOf("_")>0){
      params.prefixes = tableName.split("_")[0] + "_";
    }
    layer.open({
      content: "确认删除应用吗？"
      ,btn: ['确认',"取消"]
      ,yes: function(index, layero){
        ajax2("/generator/delCodes","post",params).then(res => {
          if(res.success){
            layer.alert("删除成功");
            var data = checkChecked('fieldTabel');
            ajax("/metadata/fieldinfo/deleteState","post",metadataObj.id).then(res3=>{
              if(res3.success){
                layer.alert("状态信息更新完毕!");
                getFields(metadataObj.id);
              }else {
                layer.alert(res3.msg);
              }
            });
          }else{
            layer.alert(res.msg);
          }
        }).catch(res=>{

        })
      }
      ,btn2: function(index, layero){
        layer.closeAll();
      }
    });

  }
  active.delFields = function(){
    doDeleteFields();
  };
  active.setTop = function () {

    layer.open({
      type: 1,
      title: "新建字段",
      area: ['550px', '670px'],
      maxmin: true,
      content: '<div id="fieldForm"></div>',
      cancel: function(){
      }
    });
    layui.laytpl($("#fieldTemplate").html()).render({}, function(html){
      $("#fieldForm").html(html);
      getDict();
      getClass();
      getDbDict();
      getGropu();
      layui.form.val("fieldForm",{tableid:metadataObj.id,tablename:metadataObj.name});
    });
  };
  active.editField = function (){
    editField();
  };
  active.sameCreate = function (){
    if(checkChecked('fieldTabel')){
      var data = getTableCheck("fieldTabel");
      layer.open({
        type: 1,
        title: "类似创建字段",
        area: ['550px', '670px'],
        maxmin: true,
        content: '<div id="fieldForm"></div>'
      });
      var field = data[0];
      field.id = "";
      layui.laytpl($("#fieldTemplate").html()).render(data[0], function(html){
        $("#fieldForm").html(html);
        getDict(data[0].fieldtype);
        getDbDict(data[0].dbtype);
        getGropu(data[0].groupid);
        layui.form.val("fieldForm",data[0]);
        layui.form.render();
      });
    }
  };

  layui.use('layer', function() { //独立版的layer无需执行这一句
    var $ = layui.jquery, layer = layui.layer; //独立版的layer无需执行这一句

    layui.use(['form'], function () {
      var form = layui.form
              , layer = layui.layer
    })
    layui.use('layer', function () { //独立版的layer无需执行这一句
      var $ = layui.jquery, layer = layui.layer; //独立版的layer无需执行这一句

      $('#select').on('click', select);

      function select() {
        var that = this;
        layer.open({
          type: 1,
          title: "选择模板",
          area: ['542px', '409px'],
          maxmin: true,
          content: $("#form1")
        });
      }
    })
  })
</script>

<script>
  var metadataObj = {};
  function editField(){

    if(checkChecked('fieldTabel')){
      var data = getTableCheck("fieldTabel");
      layer.open({
        type: 1,
        title: "修改字段",
        area: ['550px', '670px'],
        maxmin: true,
        content: '<div id="fieldForm"></div>'
      });
      layui.laytpl($("#fieldTemplate").html()).render(data[0], function(html){
        $("#fieldForm").html(html);
        validateFieldType(data[0].fieldtype);
        console.log(data[0]);
        getDict(data[0].fieldtype);
        getClass(data[0].classid);
        getDbDict(data[0].dbtype);
        getGropu(data[0].groupid);
        layui.form.val("fieldForm",data[0]);
        layui.form.render();
      });
    }
  }

  /*active.selectClass = function(){
    selectClassIndex = layer.open({
      type: 1,
      area: ['950px', '521px'],
      title:'选择分类法',
      maxmin: true,
      content: '<div id="fieldFormClass"></div>'
    });
    var jsondata = {
      "entity": {
        "parentId": 0
      },
      "pager": {
        "current": 1,
        "size": 15
      }
    }
    $.ajax({
      type:"POST",
      url:"/metadata/class/list",
      contentType:"application/json",
      data:JSON.stringify(jsondata),
      dataType:"json",
      success:function (data) {
        layui.laytpl($("#fieldTemplateClass").html()).render({}, function(html){
          $("#fieldFormClass").html(html);
        layui.form.render();
        layui.use('transfer', function(){
          var transfer = layui.transfer;
          //渲染
          var result=[];
          console.log(data);
          for (var i=0;i<data.obj.records.length;i++){
            result.push({"value":data.obj.records[i].id,"title":"<div><span>"+data.obj.records[i].className+"</span></div>","disabled": "", "checked": ""})
          }
          transfer.render({
            elem: '#test1'  //绑定元素
            ,title:['<div><span>分类法</span></div>']
            ,data:result
            ,id:"demo1"
          });
        });
        })
      },
      error:function (data) {
        console.log("出错了")
      }
    });

  }
*/
  layui.form.on("select(fieldType)",function(data){
    validateFieldType(data.value);
  })
  function validateFieldType(fieldtype){
    var dbtype = $('#dbtype').val();
    console.log(fieldtype);
    //var dbLength = $('#dbLength').val();
    if(fieldtype == 1) {
      $("#class_tr").hide();
      $("#class_tr_2").hide();
      $("#dbtype").attr("disabled", "disabled").val(2);
      $("#enum_tr").hide();
      layui.form.render();
    }else if(fieldtype == 13){
      $("#class_tr").show();
      $("#class_tr_2").show();
      $("#dbtype").val(2).attr("disabled","disabled");
      $("#enum_tr").hide();
      layui.form.render();
    }else if(fieldtype == 6){
      $("#class_tr").hide();
      $("#class_tr_2").hide();
      $("#dbtype").val(2).attr("disabled","disabled");
      $("#enum_tr").show();
      layui.form.render();
    }else if(fieldtype == 7){
      $("#class_tr").hide();
      $("#class_tr_2").hide();
      $("#dbtype").val(2).attr("disabled","disabled");
      $("#enum_tr").show();
      layui.form.render();
    }else if(fieldtype == 8){
      $("#class_tr").hide();
      $("#class_tr_2").hide();
      $("#dbtype").val(2).attr("disabled","disabled");
      $("#enum_tr").show();
      layui.form.render();
    }else if(fieldtype == 5){
      $("#class_tr").hide();
      $("#class_tr_2").hide();
      $("#dbtype").removeAttr("disabled","disabled");
      $("#enum_tr").hide();
      layui.form.render();
    }else if(fieldtype == 4){
      $("#class_tr").hide();
      $("#class_tr_2").hide();
      $("#dbtype").val(4).attr("disabled","disabled");
      $("#enum_tr").hide();
      layui.form.render();
    }else if(fieldtype == 9){
      $("#class_tr").hide();
      $("#class_tr_2").hide();
      $("#dbtype").val(5).attr("disabled","disabled");
      $("#enum_tr").hide();
      layui.form.render();
    }else{
      $("#class_tr").hide();
      $("#class_tr_2").hide();
      $("#dbtype").val(2).attr("disabled","disabled");
      $("#enum_tr").hide();
      layui.form.render();
    }
  }
  function doDeleteFields(){
    var data = checkChecked('fieldTabel');
    if(data) {
      layer.open({
        content: "确认删除表字段吗？"
        ,btn: ['确认',"取消"]
        ,yes: function(index, layero) {
          ajax("/metadata/fieldinfo/delByIds", "POST", JSON.stringify(data)).then(res => {
            if (res.success) {
//          res.msgConfig = "删除成功";
              getFields(1);
              layer.closeAll();
            } else {
              layer.alert("删除失败");
            }
          }).catch(res=>{
          })
        }
        ,btn2: function(index, layero){
          layer.closeAll();
        }
      });
    }
  }
  function checkChoice(){
    if(!metadataObj.id){
      layer.alert("请选择菜单");
      return false;
    }
    return true;
  }
  function doAddField(data){
    var metadataid = data.tableid;
    ajax("/metadata/fieldinfo/add","POST",JSON.stringify(data)).then(res=>{
      if(res.success){

          getFields(1);
          layer.closeAll();
      }else{
        layer.alert(res.msg,function(){
          layer.closeAll();
        });
      }
    })
  }
  function doEditField(data){
    var metadataid = data.tableid;
    ajax("/metadata/fieldinfo/"+data.id,"put",JSON.stringify(data)).then(res=>{
      if(res.success){

          getFields(1);
          layer.closeAll();
      }else{
        layer.alert(res.msg,function(){
          layer.closeAll();
        });
      }
    })
  }
  function doAddMetadata(data){
    data.tablename = data.preTbm+data.tablename;
    ajax("/metadata/add","post",JSON.stringify(data)).then(res=>{
      if(res.success){
          layer.closeAll();
          getMetadatas(1);
      }else{

        var index = layer.alert("您输入的信息有误，请重新输入。",function(){
          layer.close(index);
        });
      }
    })
  }
  function doAddView(data){
    data.viewname = data.viewTbm+data.viewname;
    console.log(data.viewsf);
    ajax("/metadata/view/create?id="+metadataObj.id+"&viewname="+data.viewname,"post",data.viewsf).then(data=>{
      if(data.success){
        layer.alert(data.msg);
        setTimeout(function(){
          layer.closeAll();
          getMetadatas(1);
        }, 500);

      }else{
        layer.alert(data.msg);
      }
    })
  }
  function doEditMetadata(data){
    ajax("/metadata/"+data.id,"put",JSON.stringify(data)).then(res=>{
      if(res.success){
          layer.closeAll();
          getMetadatas(1);
      }else{
        layer.alert(res.msg,function(){
          layer.closeAll();
        });
      }
    })
  }
  function getMetadatas(pageNo){
    var jsondata = {
      "pager": {
        "current": pageNo,
        "size": 10
      }
    }
    ajax("/metadata/list","post",JSON.stringify(jsondata)).then(data=>{
      console.log(data);
      if(data.success){
        if(data.obj.records.length>0){
          metadataObj.id = data.obj.records[0].id;
          metadataObj.name = data.obj.records[0].tablename;
          getFields(1);
        }
        var html = "";
        for(var i in data.obj.records){
          var obj = data.obj.records[i];
          var activeClass = "";
          if(i == 0) {
            activeClass = "active";
          }
          html += '<div class="layui-form-item '+activeClass+'" data_id="'+obj.id+'" data_name="'+obj.tablename+'" pane="">' +
                  '              <div class="layui-form-label"><input type="checkbox" name="listid" value="'+obj.id+'" lay-skin="primary"></div>' +
                  '              <div class="layui-input-block">' +
                  '                <p>'+obj.anothername+' ['+obj.tablename+']</p>' +
                  '                <p>创建时间:'+obj.crtime+'</p>' +
                  '              </div>' +
                  '            </div>';
        }
        $("#listForm").html(html);

        var laypage = layui.laypage
                ,layer = layui.layer;

        layui.use(['laypage', 'layer'], function(){
          laypage.render({
            elem: 'pageleft'
            ,count: data.obj.total //数据总数
            ,curr:data.obj.current
            ,jump: function(obj,first){
              if(!first){
                getMetadatas(obj.curr)
              }
            }
          });
        });

        layui.form.render();
      }
    });
  }
  function getDict(id){
    ajax("/metadata/dict/list","post",JSON.stringify("field_type")).then(data=>{
      for(var i in data){
        $("#fieldtype").append("<option value='"+data[i].no+"'>"+data[i].name+"</option>");
      }
      layui.form.render('select');
      layui.form.val("fieldForm",{fieldtype:id});
    })
  }
  //获得分类法分类
  function getClass(id){
    var jsondata = {
      "entity": {
        "parentId": 0
      },
      "pager": {
        "current": 1,
        "size": 20
      }
    }
    ajax("/metadata/class/list","post",JSON.stringify(jsondata)).then(data=>{
      console.log(data,id);
      for(var i in data.obj.records){
        $("#classId").append("<option value='"+data.obj.records[i].id+"'>"+data.obj.records[i].className+"</option>");
      }
      layui.form.val("fieldForm",{classId:id});
      layui.form.render('select');
    })
  }
  function getDbDict(id){
    ajax("/metadata/dict/list","post",JSON.stringify("db_type")).then(data=>{
      for(var i in data){
          $("#dbtype").append("<option value='" + data[i].no + "'>" + data[i].name + "</option>");
        console.log(data[i].no);
      }
      layui.form.render('select');
      layui.form.val("fieldForm",{dbtype:id});
    })
  }
  function getGropu(id){
    ajax("/metadata/group/all","post",{}).then(data=>{
      for(var i in data.obj){
          $("#groupid").append("<option value='" + data.obj[i].id + "'>" + data.obj[i].name + "</option>")
      }
      layui.form.render('select');
      layui.form.val("fieldForm",{groupid:id});
    })
  }
  function getFields(pageNo){
    var jsondata = {
      "entity": {
        "tableid": metadataObj.id
      },
      "pager": {
        "current": pageNo,
        "size": 15
      }
    }
    ajax("/metadata/fieldinfo/list","post",JSON.stringify(jsondata)).then(data=>{
      console.log(data);
      layui.use('table', function(){
        var table = layui.table;
        table.render({
          elem: '#fieldTabel'
          ,data:data.obj.records
          ,cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
          ,cols: [[
            {type:'checkbox'}
            ,{type:'numbers',title: '序号'}
            ,{field:'anothername', title: '中文名称', sort: true}
            ,{field:'fieldname',  title: '英文名称'}
            ,{field:'fieldTypeStr', title: '字段类型', minWidth: 100} //minWidth：局部定义当前单元格的最小宽度，layui 2.2.1 新增
            ,{field:'dbTypeStr', title: '库中类型', sort: true}
            ,{field:'groupname', title: '所属分组'}
            ,{field:'generatestate',  title: '是否生成java代码应用', sort: true, templet: "#state1"}
            ,{field:'generatetime',  title: '生成时间', sort: true}
          ]],
          limit:15
        });
      });
      layui.laypage.render({
        elem: 'fieldPage'
        ,count: data.obj.total //数据总数
        ,curr:data.obj.current
        ,limit:15
        ,jump: function(obj,first){
          if(!first){
            getFields(obj.curr);
          }
        }
      });
    })
  }

  //选择模板
   var selectIndex;
  function selectTemp() {
      var jsondata={
              "entity":{
                  "tempname":""
              }
          }

      $.ajax({
          type:'post',
          url:'/manage/tableTemplate/getTemp',
          contentType:'application/json',
          data:JSON.stringify(jsondata),
          dataType:'json',
          success:function (data) {
              console.log(data.obj)
              selectIndex = layer.open({
                  type:1,
                  title:'选择模板',
                  area:['800px','600px'],
                  maxmin:false,
                  content:'<div id="templateDiv"></div>'
              })
              layui.laytpl($("#tempContent").html()).render(data.obj,function (html) {
                  $("#templateDiv").html(html)
              })
          }
      })

  }
  //选择模板确定
  function addTemp() {
      var data =$('input:radio:checked').val();
      //console.log(data)
      $("#modelId").attr('value',data)
      layer.close(selectIndex);
  }

  //生成视图
  /*function create() {
      var ids = [];
      $("input[name='listid']:checked").each(function(){
          ids.push($(this).val());
      })
      if(ids.length<=0){
          layer.alert("请选择元数据");
          return false;
      }
      ajax("/metadata/view/createView","post",JSON.stringify(ids)).then(data=>{
          if(data.success){
//            layer.alert(data.msgConfig,function(index){
//                layer.close(index);
//            });
          layer.closeAll()
        }else{
            layer.alert(data.msgConfig);
        }
      })
  }*/


  //生成视图
  function create() {
    var fields = [];
    var data = getTableCheck("fieldTabel");
    console.log(data);
    if(data.length <= 0){
      layer.alert("请选择表字段！");
      return false;
    }
    data.forEach(res=>{
      fields.push(res.fieldname);
    })
    createView(fields);
  }
  function del(){
    var ids = [];
    $("input[name='listid']:checked").each(function(){
      ids.push($(this).val());
    })
    if(ids.length<=0){
      layer.alert("请选择元数据");
      return false;
    }
    layer.open({
      content: "确认删除该元数据表吗？"
      ,btn: ['确认',"取消"]
      ,yes: function(index, layero){
        ajax("/metadata/delByIds","post",JSON.stringify(ids)).then(data=>{
          if(data.success){
            getMetadatas(1);
            layer.close(index);
          }else{
            layer.alert(data.msg);
          }
        }).catch(res=>{

        })
      }
      ,btn2: function(index, layero){
        layer.closeAll();
      }
    });
  }
  function add(){
    //多窗口模式，层叠置顶
    layer.open({
      type: 1,
      title: "新建元数据",
      area: ['600px', '450px'],
      maxmin: true,
      content: '<div id="addMetadataForm"></div>',
    });
    layui.laytpl($("#metadataTemplate").html()).render({edit:false}, function(html){
      $("#addMetadataForm").html(html)
    });
    layui.form.val("metadataForm",{preTbm:"JMETA_",ownerid: 0});
  }
  function edit(){
    if(checkChoice()){
      ajax("/metadata/"+metadataObj.id,"get",{}).then(data=>{
        layer.open({
          type: 1,
          title: "修改元数据",
          area: ['600px', '450px'],
          maxmin: true,
          content: '<div id="addMetadataForm"></div>',
        });
        layui.laytpl($("#metadataTemplate").html()).render({edit:true}, function(html){
          $("#addMetadataForm").html(html)
        });
        layui.form.val("metadataForm",data.obj);
      })
    }
  }
  function createView(viewsf){
    //多窗口模式，层叠置顶
    layer.open({
      type: 1,
      title: "视图命名",
      area: ['600px', '300px'],
      maxmin: true,
      content: '<div id="viewForm"></div>',
    });
    layui.laytpl($("#viewTemplate").html()).render({}, function(html){
      $("#viewForm").html(html)
    });
    layui.form.val("viewForm",{viewTbm:"VIEW_JMETA_",viewsf: JSON.stringify(viewsf)});
  }
</script>

<script>
  $(function(){
    $(".left-list").on("mouseover",".layui-form-item",function(){
      $(this).addClass("active2").siblings().removeClass("active2");
    })
    $(".left-list").on("mouseleave",".layui-form-item",function(){
      $(this).removeClass("active2");
    })
    $(".left-list").on("click",".layui-input-block",function(){
      $(".left-list input").prop("checked",false);
      $(this).parent().find("input").prop("checked",true);
      layui.form.render();
      $(this).parent().addClass("active").siblings().removeClass("active");
      metadataObj.id = $(this).attr("data_id");
      metadataObj.name = $(this).attr("data_name");
      getFields(1);
    })
    layui.form.render();
    getMetadatas(1);
  })
</script>