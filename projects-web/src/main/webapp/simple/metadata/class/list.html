<title>元数据分类法管理</title>

<style>
    .addColor{background: rgba(218, 250, 162, 1)}
    .left-list .layui-form-label{padding: 0px; width: auto;}
    .left-list .layui-input-block { margin-left: 28px;}
    .left-list .layui-form-item .layui-form-checkbox[lay-skin=primary] {  margin-top: 5px;}
    .left-list .active{background:rgba(218, 250, 162, 1)}
    .left-list .active2{background:rgba(218, 250, 162, 1)}
    .left-list .layui-card-body{padding:10px 0;height: 85%;}
    .left-list .layui-form-item{padding:8px 15px;margin-bottom: 0px;cursor: pointer;}
    .left-list .layui-btn-container{padding-left:25px;}
    .layui-tab-item {position: relative;}
    .layui-form select option{color: black;}
    li .layui-form-checkbox[lay-skin=primary] div span:nth-of-type(1){width: 80px;}
    li .layui-form-checkbox[lay-skin=primary] div span:nth-of-type(2){width: 80px; margin-left: 45px;}
</style>

<div class="layui-card layadmin-header">
    <div class="layui-breadcrumb" lay-filter="breadcrumb">
        <a lay-href="">主页</a>
        <a><cite>应用</cite></a>
        <a><cite>分类管理</cite></a>
    </div>
</div>

<div class="layui-fluid">
    <div class="layui-row layui-col-space12 h100">
        <div class="layui-col-md3 left-list h100" style="width: 23%;">
            <div class="layui-card h100">
                <div class="layui-card-header">分类法名称</div>
                <div class="layui-card-body">
                    <div class="layui-btn-container">
                        <button type="button" class="layui-btn layui-btn-sm" data-type="addfu"><i class="layui-icon">&#xe608;</i> 添加</button>
                        <button type="button" class="layui-btn layui-btn-sm" data-type="editfu"><i class="layui-icon">&#xe642;</i> 修改</button>
                        <button type="button" class="layui-btn layui-btn-sm" data-type="delfu"><i class="layui-icon">&#xe640;</i> 删除</button>
                    </div>
                    <div class="layui-btn-container">
                        <button type="button" class="layui-btn layui-btn-sm" id="import"> 导入分类法</button>
                        <button type="button" class="layui-btn layui-btn-sm" onclick="doexport()"> 导出分类法</button>
                    </div>
                    <form class="layui-form" action="" id="treeDemo0" style='position: relative;'>
                    </form>
                </div>
                <div class="" id="pageleft" style="padding-left: 10px"></div>
            </div>
        </div>
        <div class="layui-col-md3 h100" style="width: 25%">
            <div class="layui-card h100">
                <div class="layui-card-header">分类法树</div>
                <div class="layui-card-body">
                    <div class="button-container">
                        <button type="button" class="layui-btn layui-btn-sm" data-type="add">
                            <i class="layui-icon">&#xe608;</i> 添加
                        </button>
                        <button type="button" class="layui-btn layui-btn-sm" data-type="edit">
                            <i class="layui-icon">&#xe642;</i> 修改
                        </button>
                        <button type="button" class="layui-btn layui-btn-sm" data-type="del">
                            <i class="layui-icon">&#xe640;</i> 删除
                        </button>
                        <button type="button" class="layui-btn layui-btn-sm" id="importCate">
                            导入分类法的分类
                        </button>
                    </div>
                    <div style="width: 300px; overflow: hidden;">
                        <ul id="treeDemo" class="ztree"></ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-col-md3 h100" style="width: 52%">
            <div class="layui-card h100">
                <div class="layui-card-body">
                    <div style=" display: inline-block;width: 100%;">
                        <!--<button class="layui-btn layuiadmin-btn-admin" data-type="batchdel">新建分类法</button>-->
<!--
                        <button class="layui-btn layuiadmin-btn-admin" id="import">导入分类法</button>
-->
                        <!--<button class="layui-btn layuiadmin-btn-admin" style="margin-left: 10px;">维护分类法</button>-->
<!--
                        <button class="layui-btn layuiadmin-btn-admin" data-type="delAll" style="margin-left: 10px;">删除分类法</button>
-->
<!--                        <button class="layui-btn layuiadmin-btn-admin" style="margin-left: 10px;" onclick="doexport()">导出分类法</button>
                        <button type="button" class="layui-btn layuiadmin-btn-admin" id="importCate">导入分类法的分类</button>-->
                        <!--<div class="layui-form-item" style="display: inline-block;float: right">
                            <div class="layui-form-label" style="float:left;white-space: nowrap;">分类法名称：</div>
                            <div class="layui-input-block" style="float: left;margin-left:0px;">
                                <input type="text" id="search" name="title" required lay-verify="required" placeholder="请输入"
                                       autocomplete="off" class="layui-input">
                            </div>
                            <button class="layui-btn" style="display: inline-block;margin-left: 20px" onclick="doSearch(1)"><i
                                    class="layui-icon layui-icon-search"></i></button>
                        </div>-->
                    </div>
                    <div class="layui-tab-item" id="detail" style="height: 650px;">
                        <table class="layui-table" lay-even="" lay-skin="row" id="info"
                               style="margin-left: 20px;">
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/html" id="siteDetail">
<!--
    <div class="layui-card-header">分类法详细信息</div>
-->
    {{#layui.each(d,function(index,item){}}
    <colgroup>
        <col width="50">
        <col width="150">
        <col>
    </colgroup>
    <tbody>
    <tr>
        <td align="center" colspan="2">
            分类法详细信息
        </td>
    </tr>
    <tr>
        <td>分类法ID：</td>
        <td>{{item.id}}</td>
    </tr>
    <tr>
        <td>分类法名称：</td>
        <td>{{item.className}}</td>
    </tr>
    <tr>
        <td>分类法描述：</td>
        <td>{{item.classDesc}}</td>
    </tr>
    <tr>
        <td>创建人：</td>
        <td>{{item.cruser}}</td>
    </tr>
    <tr>
        <td>创建时间：</td>
        <td>{{item.crtime}}</td>
    </tr>
    </tbody>
    <!--{{#}) }}-->
</script>
<!--弹出层模板（新增，查看，编辑）-->
<script type="text/html"  id="editTemplate">
    <form class="layui-form" lay-filter="editForm">
        <div class="layui-card">
            <div class="layui-card-body">
                <div class="layui-form-item">
                    <label class="layui-form-label">父级分类:</label>
                    <div class="layui-input-block">
                        <input type="text" name="parentName" readonly autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">分类法名称:</label>
                    <div class="layui-input-block">
                        <input type="text" name="className" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">分类法描述:</label>
                    <div class="layui-input-block">
                        <input type="text" name="classDesc" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
        </div>
        <input hidden="hidden" name="id">
        <input hidden="hidden" name="parentId">
        <div class="button-bar">
            <button class="layui-btn" lay-submit lay-filter="addBtn">确认</button>
            <button class="layui-btn" type="button" data-type="close">取消</button>
        </div>
    </form>
</script>
<script>
    var listObj = {};
    var modelObj = {id:0,className:"根分类"};
    var limit = 15;
    var url = "/metadata/class";
    layui.use('table', function () {
        var table = layui.table
            , upload = layui.upload
            , $ = layui.$;

        //导入分类法
        upload.render({
            elem: '#import'
            , url: url+'/import'
            , accept: 'file' //excel文件
            ,before:function(){
                layer.load();
            }
            , done: function (res) {
                layer.alert(res.msg,function(){
                    getParentTree(1);
                });
            },
        });
        //导入分类法的分类layui
        upload.render({
            elem: '#importCate'
            , url: url+'/importCategory'
            , accept: 'file' //excel文件
            ,data: {
                id: function(){
                    var data = layui.table.checkStatus("classTable").data;
                    if(data[0]){
                        return data[0].id;
                    }else{
                        return -1;
                    }
                }
            }
            ,before:function(){
                layer.load();
            }
            , done: function (res) {
                layer.alert(res.msg,function(){
                    getParentTree(1);
                });
            },

        });
    });

    function doexport() {
        window.location.href = "/metadata/class/exportList?current=1&size=15";
    }

    function doSearch(pageNo) {
        var jsondata = {
            "entity": {
                "className": $("#search").val(),
                "parentId": modelObj.id
            },
            "pager": {
                "current": pageNo,
                "size": limit
            }
        }
        ajax(url+"/list","POST",JSON.stringify(jsondata)).then(res=>{
            console.log(res);
            layui.use(['laypage', 'table'], function () {
                var table = layui.table
                    , laypage = layui.laypage;
                laypage.render({
                    elem: 'demo8',
                    count: res.obj.total, //数据总条数
                    limit: limit, //每页条数
                    curr: res.obj.current, //当前页码
                    jump: function (obj, first) {
                        if (!first) {
                            doSearch(obj.curr);
                        }
                    }
                })
                table.render({
                    elem: '#classTable'
                    , data: res.obj.records
                    , cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                    , cols: [[
                        {type: 'checkbox',width:'3%'}
                        , {type: 'numbers', width: '7%', title: '序号'}
                        , {field: 'className', width: '24%', title: '名称'}
                        , {field: 'classDesc', width: '40%', title: '描述'}
                        , {field: 'cruser', width: '13%', title: '创建人'}
                        , {field: 'crtime', width: '13%', title: '创建时间'} //minWidth：局部定义当前单元格的最小宽度，layui 2.2.1 新增
                    ]]
                    , limit: 15

                });
                table.on('row(LAY-app-content-tags)', function (obj) {
                    var data = obj.data;
                    //标注选中样式
                    obj.tr.addClass('layui-table-click').siblings().removeClass('layui-table-click');
                });
            });
        }).catch(res=>{

        })
    }

    function delAll(){
        var data = checkChecked('classTable');
        if(data){
            ajax(url+"/delByIds","post",JSON.stringify(data)).then(res=>{
                layer.alert("删除成功", function (index) {
                    getParentTree(1);
                    layer.closeAll();
                })
            }).catch(res=>{
                layer.alert(res.msg);
            })
        }
    }

    function add(){
        openEditView({parentId:modelObj.id,parentName:modelObj.className});
    }
    active.addfu = function(){
        openEditView({parentId:0,parentName:"根分类"});
    }

    function openEditView(data){
        console.log(data);
        layui.layer.open({
            type: 1,
            title:"数据<span style='color: red;float:right' id='tempMsg'>",
            area:['360px','310px'],
            anim: 2,
            content: '<div id="editView"></div>'
        });
        layui.laytpl($("#editTemplate").html()).render({}, function(html){
            $("#editView").html(html)
            layui.form.val("editForm",data);
            layui.form.render();
        });
    }

    function edit(){
        if(modelObj.id == 0){
            layer.alert("请选择分类");
        }else{
            openEditView(modelObj);
        }
    }
    active.editfu = function () {
        if(modelObj.id == 0){
            layer.alert("请选择分类");
        }else{
            openEditView(modelObj);
        }
    }
    active.delfu = function () {
            delfuall();
    }
    function delfuall(){
        var ids = [];
        $("input[name='treedemo0']:checked").each(function(){
            ids.push($(this).val());
        })
        if(ids.length<=0){
            layer.alert("请选择元数据");
            return false;
        }
        layer.open({
            content: "确认删除该分类法吗？"
            ,btn: ['确认',"取消"]
            ,yes: function(index, layero){
                ajax("/metadata/class/delByIds","post",JSON.stringify(ids)).then(data=>{
                    if(data.success){
                        getParentTree(1);
                        layer.closeAll();
                    }else{
                        layer.alert("删除失败！");
                    }
                }).catch(res=>{

                })
            }
            ,btn2: function(index, layero){
                layer.closeAll();
            }
        });
    }

    function del(){
        /*if(modelObj.parentName == "根分类"){
            layer.alert("请选择分类法");
        }else{*/
            layer.open({
                content: "确认删除分类法:["+modelObj.className+"]及该分类法下级分类吗"
                ,btn: ['确认',"取消"]
                ,yes: function(index, layero){
                    ajax(url+"/"+modelObj.id,"delete",{}).then(res=>{
                        if(res.success){
                            res.msg = "删除成功";
                        }
                        layer.alert(res.msg,function(){
                            getParentTree(1);
                            layer.closeAll();
                        });
                    }).catch(res=>{

                    })
                }
                ,btn2: function(index, layero){
                    layer.closeAll();
                }
            });

    }

    function getParentTree(pageNo){
        var jsondata = {
            "pager": {
                "current": pageNo,
                "size": 10
            },"entity": {
                "parentid": 0
            }
        }
        ajax(url+"/list","post",JSON.stringify(jsondata)).then(data=>{
            console.log(data);
            if(data.success){
                if(data.obj.records.length>0){
                    getChildTree(data.obj.records[0].id);
                    modelObj.id = data.obj.records[0].id;
                    modelObj.className = data.obj.records[0].className;
                }
                var html = "";
                for(var i in data.obj.records) {

                    var obj = data.obj.records[i];
                    var activeClass = "";
                        if (i == 0) {
                            activeClass = "active";
                        }
                        html += '<div class="layui-form-item ' + activeClass + '" data_id="' + obj.id + '" data_name="' + obj.className + '"data_desc="' + obj.classDesc + '"pane="">' +
                            '              <div class="layui-form-label"><input type="checkbox" name="treedemo0" value="' + obj.id + '" lay-skin="primary"></div>' +
                            '              <div class="layui-input-block">' +
                            '                <p>' + obj.className + '['+obj.id+']</p>' +
                            '                <p>创建时间:' + obj.crtime + '</p>' +
                            '              </div>' +
                            '            </div>';
                }
                $("#treeDemo0").html(html);
                var laypage = layui.laypage
                    ,layer = layui.layer;
                layui.use(['laypage', 'layer'], function(){
                    laypage.render({
                        elem: 'pageleft'
                        ,count: data.obj.total //数据总数
                        ,curr:data.obj.current
                        ,jump: function(obj,first){
                            if(!first){
                                getParentTree(obj.curr)
                            }
                        }
                    });
                });
                layui.form.render();
            }
        })
    }
//获得子树
    function getChildTree(id){
        var jsondata = {
                "parentId": id
        }
        ajax("/metadata/class/tree","post",JSON.stringify(jsondata)).then(data=>{
            var res = data.obj;
            console.log(res);
            if(res){
                getSelectMess(res[0].id);
            }else{
                getSelectMess(id);
            }
            for(var i in res){
                if(res[i].parentId == modelObj.id){
                    res[i].icon = "img/u5554.png";
                }else{
                    res[i].icon = "img/u2615.png";
                }

            }
            showTree(res);
        })
    }

    function getSelectMess(id){
        var jsondata = {
            "pager": {
                "current": 1,
                "size": 10
            },"entity": {
                "id": id
            }
        }
        ajax(url+"/list","post",JSON.stringify(jsondata)).then(data=> {
            console.log(data.obj.records);
            if(data.success) {
                var d = [];
                d.push(data.obj.records[0]);
                console.log(d.id);
                layui.laytpl($("#siteDetail").html()).render(d, function (html) {
                    $("#info").html(html);
                    layui.form.render();
                })
                document.getElementById("detail").className = "layui-tab-item layui-show";
            }
        });
    }


    $(function () {
        $(".left-list").on("mouseover",".layui-form-item",function(){
            $(this).addClass("active2").siblings().removeClass("active2");
        })
        $(".left-list").on("mouseleave",".layui-form-item",function(){
            $(this).removeClass("active2");
        })
        $(".left-list").on("click",".layui-input-block",function(){
            $(".left-list input").prop("checked",false);
            $(this).parent().find("input").prop("checked",true);
            layui.form.render();
            $(this).parent().addClass("active").siblings().removeClass("active");
            modelObj.id = $(this).attr("data_id");
            modelObj.className = $(this).attr("data_name");
            modelObj.classDesc = $(this).attr("data_desc");
            console.log($(this).attr("data_id"));
            getChildTree($(this).attr("data_id"));
        })
        layui.form.render();
        getParentTree(1);
    })



</script>

<script>
    //ztree
    var settings = {
        data: {
            simpleData: {
                enable: true,  //true 、 false 分别表示 使用 、 不使用 简单数据模式
                idKey: "id",  //节点数据中保存唯一标识的属性名称
                pIdKey: "parentId",    //节点数据中保存其父节点唯一标识的属性名称
                rootPId: 0  //用于修正根节点父节点数据，即 pIdKey 指定的属性值
            },
            key: {
                name: "className"
            }
        },
        view: { showLine: false,showIcon:true },
        callback: {
            onClick: zTreeOnClick
        }
    };

    //渲染树结构
    function showTree(data) {
        zTreeObj = $.fn.zTree.init($("#treeDemo"), settings, data); //初始化树
        zTreeObj.expandAll(true);    //true 节点全部展开、false节点收缩、
    }

    function zTreeOnClick(event, treeId, treeNode) {
        modelObj.id = treeNode.id;
        modelObj.className = treeNode.className;
        modelObj.classDesc = treeNode.classDesc;
        modelObj.parentName = treeNode.getParentNode()?treeNode.getParentNode().className:"根分类";
        getSelectMess(modelObj.id);
        //getParentTree(1);
    };

</script>

<script>
    layui.form.on("submit(addBtn)",function(data){
        var thisUrl = url;
        var method = "post";
        if(data.field.id){
            msg = "修改成功";
            thisUrl = url+"/"+data.field.id;
            method = "put";
        }
        if(data.field.id == 0){
        ajax(thisUrl,method,JSON.stringify(data.field)).then(res=>{
            layer.closeAll();
            getParentTree(1);
        }).catch(res=>{
        })}else {
            ajax(thisUrl,method,JSON.stringify(data.field)).then(res=>{
                layer.closeAll();
                getChildTree(modelObj.id);
            }).catch(res=>{
            })
        }
        return false;
    })
</script>