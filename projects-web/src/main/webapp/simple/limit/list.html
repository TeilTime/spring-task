<title>权限操作管理</title>
<style>
  #nav span,.right span{display: none;}
  #nav a{display: inline-block;width: 40px;height: 56px;text-align: center;border: 1px solid #f5f5f5;}
  #nav a:nth-of-type(3){display: inline-block;width: 170px;height: 52px; text-align: left;padding-left: 20px;border-top: 2px solid #000;font-weight: bold;}
  .right{display: inline-block;position: absolute;top: 0;right: 0;}
  .layui-breadcrumb a{color: #000!important;}
  .layui-table-header,.layui-table-view,.layui-table-box{overflow: visible;}
  .layui-table-link:hover{color: #009688!important;}
  .layui-card-header p{margin-top: 10px;margin-left: 10px;}
  .layui-form-item .layui-input-block{display: inline-block;margin-left: -5px;}
  #select .layui-form-select{width: 327px;}
  label span{color: red; margin-right: 5px;}
  .layui-transfer-header{position: relative;}
  .layui-transfer-box:first-of-type{width: 410px!important;}
  .layui-transfer-box:last-of-type{width: 360px!important;}
  .layui-transfer-header{background: #009688;line-height: 38px;}
  .layui-transfer-header .layui-form-checkbox[lay-skin=primary] span{margin-left: 30px; display: inline-block;height: 38px;line-height: 36px; color: #fff!important;}
  .layui-form-checkbox[lay-skin=primary] span{margin-left: 30px; display: inline-block;height: 38px;line-height: 36px;}
  .layui-form-checkbox[lay-skin=primary] span:first-of-type{margin-left: 0px;}
  .layui-transfer-box .layui-form-checkbox i{top: 10px;}
  th .layui-table-cell{text-align: center}
</style>
<div class="layui-card layadmin-header">
  <div class="layui-breadcrumb" lay-filter="breadcrumb" id="nav">
    <a><i class="layui-icon layui-icon-prev"></i></a>
    <a lay-href=''><i class="layui-icon layui-icon-home"></i></a>
    <a>权限操作<i class="layui-icon layui-icon-close" style="margin-left: 50px"></i></a>
    <div class="right">
      <a><i class="layui-icon layui-icon-next"></i></a>
      <a><i class="layui-icon layui-icon-down"></i></a>
    </div>
  </div>
</div>
<div class="layui-fluid">
  <div class="layui-card h100"  id="index">
    <div class="layui-card-body">
      <div class="layui-btn-container" style="display: inline-block;margin-top: 20px;">
        <button type="button" class="layui-btn layui-btn-sm" data-type="add"><i class="layui-icon">&#xe608;</i> 新建权限操作</button>
        <!--<button type="button" class="layui-btn layui-btn-sm" data-type="edit"><i class="layui-icon">&#xe642;</i> 修改</button>-->
        <button type="button" class="layui-btn layui-btn-sm" data-type="delLimit"><i class="layui-icon">&#xe640;</i> 删除权限操作</button>
      </div>
      <form class="layui-form">
      <table id="test" lay-filter="test"></table>
      </form>
      <div id="demo8"></div>
    </div>
  </div>
</div>

<script type="text/html" id="titleTpl">
  <a href="javascript:void(0);" class="layui-table-link" style="color:#000" onclick="go()">{{d.content}}</a>
</script>
<script type="text/html" id="fieldTemplate">
  <form class='layui-form' lay-filter="editForm">
    <div class="layui-form-item" style='margin-top:10px;'>
      <label class="layui-form-label">权限名称</label>
      <div class="layui-input-block" style='height:38px;width:327px;overflow:hidden;border-radius:2px;margin-left: 10px'>
        <input id="person" type="text" name="name" lay-verify="title" autocomplete="off" placeholder="请输入" class="layui-input">
      </div>
    </div>
    <div class="layui-form-item" style='margin-top:10px;'>
      <label class="layui-form-label">权限分类</label>
      <div class="layui-input-block" id='select' style="margin-left: 10px">
        <select name="type" id="limitType" lay-filter="aihao">
          <option value="0" selected>请选择权限分类</option>
        </select>
      </div>
    </div>
    <div class="layui-form-item" style='margin-top:10px;'>
      <label class="layui-form-label">权限值</label>
      <div class="layui-input-block" style='height:38px;width:327px;overflow:hidden;border-radius:2px;margin-left: 10px'>
        <input type="text" name="value" lay-verify="title" autocomplete="off" placeholder="请输入" class="layui-input">
      </div>
    </div>
    <!--<div class="layui-form-item" style='margin-top:10px;'>
      <label class="layui-form-label">系统定义</label>
      <div class="layui-input-block" style='height:38px;width:327px;overflow:hidden;border-radius:2px;margin-left: 10px'  id="limitvalue">

        {{#if(d.system===1){ }}
        <input type="radio" name="system" class="layui-input" checked="checked" value="1" disabled>是
        <input type="radio" name="system"  class="layui-input"  value="0" disabled>否
        {{#} else { }}
        <input type="radio" name="system" class="layui-input" checked="checked" value="1" >是
        <input type="radio" name="system"  class="layui-input"  value="0" >否
        {{#} }}

      </div>
    </div>-->
    <div class="layui-form-item" style='margin-top:10px;'>
      <label class="layui-form-label">权限描述</label>
      <div class="layui-input-block" style='height:38px;width:327px;border-radius:2px;margin-left: 10px'>
        <textarea name="desc" placeholder="请输入描述" class="layui-textarea"></textarea>
      </div>
    </div>
    <input hidden="hidden" name="id">
    <div class='layui-btn-container' style='margin:90px 0 0 290px;'>
      <button class='layui-btn' type="button" lay-submit lay-filter ="addLimit">确定</button>
      <button class="layui-btn" type="button" data-type="close">取消</button>
    </div>
  </form>
</script>

<!--操作列模板-->
<script type="text/html" id="barDemo">
  {{# if(d. status == 1){ }}
  <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
  <a class="layui-btn layui-btn-disabled layui-btn-xs">删除</a>
  <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="changeStatus">已禁用</a>

  {{#} else  if(d. status == 0){ }}
  <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
  <a class="layui-btn layui-btn-xs" lay-event="changeStatus">已开启</a>

  {{# } }}
</script>

<!--显示分类列模板-->
<script type="text/html" id="typeDemo">
  {{#if(d.rightType===1){ }}
  站点类
  {{#} else if(d.rightType===2){ }}
  栏目类
  {{#} else if(d.rightType===3){ }}
  栏目文档类
  {{#} else if(d.rightType===4){ }}
  公司类
  {{#} else if(d.rightType===5){ }}
  文档类
  {{#} else if(d.rightType===6){ }}
  菜单类
  {{#} else if(d.rightType===7){ }}
  模板类
  {{#} }}

</script>

<!--<script id="checkBoxTpl" type="text/html">
 <div class="layui-table-cell laytable-cell-12-0-0 laytable-cell-checkbox">
   <input type="checkbox" disabled name="layTableCheckbox" lay-skin="primary">
 </div>
</script>-->

<script>
   var limitIndex;
    $(function () {
        getLimitData(1,15);
    })

    layui.form.on("submit(addLimit)",function (data) {
        var id=data.field.id;
        if (id===""||id===null){
          var thisUrl="/manage/limit";
          var type="post";
          var msg="添加成功"
        }else{
            thisUrl="/manage/limit/"+id;
            type="put";
            msg="修改成功"
        }
        ajax(thisUrl,type,JSON.stringify(data.field)).then(res=>{
            if(res.success){
//            res.msgConfig=msgConfig;
//            layer.alert(res.msgConfig)
            layer.close(limitIndex)
            getLimitData(1,15)
           }else{
            layer.alert(msg)
        }
        })
        return false;
    })
   function changeStatus(data) {

       ajax("/manage/limit/getStatus", "post", JSON.stringify(data.id)).then(res =>{

       doList(1, 15)
   })

   }

        //加载数据
    function  getLimitData(pageNo,size) {
        var jsondata={
            "pager":{
                "current":pageNo,
                "size":size
            }
        }
        $.ajax({
            type:"POST",
            url:"/manage/limit/list",
            contentType:"application/json",
            data:JSON.stringify(jsondata),
            dataType:"json",
            success:function (data) {
                layui.use(['table','laypage'],function () {
                    var table=layui.table,
                    laypage=layui.laypage;
                    table.render({
                        elem:"#test"
                        ,data:data.obj.records
                        ,cols: [[
                            { type:'checkbox'}
                            ,{type:'numbers', title: '序号',width:'110', title: '序号',align: 'right'}
                            ,{field:'name', width:'250', title: '权限名称',align: 'left'}
                            ,{field:'typename', width:'300', title: '权限分类',align: 'left'}
                            ,{field:'desc', width:'350', title: '权限描述',align: 'left'}
                            ,{field:'system', width:'150', title: '是否系统定义',templet:"#sys",align: 'left'}
                            ,{field:'', width:'300', title: '操作',toolbar: '#barDemo',align: 'left'}
                        ]]
                        ,limit:15
                        ,done:function(){

                            data.obj.records.forEach(function(v){

                               if(v.system==1){
                                    $("input:checkbox:eq("+(v.LAY_TABLE_INDEX+1)+")").prop("disabled",true);
                                }
                            })

                        }
                    });
                    laypage.render({
                        elem:'demo8'
                        ,count:data.obj.total
                        ,curr:data.obj.current
                        ,limit:data.obj.size
                        ,layout:['count','prev','page','next','refresh','skip']
                        ,jump:function (obj,first) {
                            if (!first){
                                getLimitData(obj.curr,15)
                            }
                        }
                    })

                })
            },
            error:function (data) {
                layer.alert(data.msg)
            }
        })
    }

   // 删除
   function delById(id){
     $.ajax({
         type:"delete",
         url:"/manage/limit/"+id,
         dataType:"json",
         success:function (data) {
//             layer.alert(data.msgConfig);
             getLimitData(1,15)
         }
     })
   }
   //批量删除
   active.delLimit=function () {
       var checkStatus=layui.table.checkStatus("test"),
           data=checkStatus.data;
       var ids="";
       for (var i in data){
           ids=ids+data[i].id;
           if(i<data.length-1){
               ids=ids+",";
           }
       }
       // console.log(ids)
       if (ids.length===0){
           layer.alert('请选择要删除的消息')
           return
       }
       if (confirm("是否确定删除,该操作不可撤回")){
           var dataIds={
               "ids":ids
           };
           $.ajax({
               type:"GET",
               url:"/manage/limit/delByIds",
               contentType:"application/json",
               data:dataIds,
               dataType:"json",
               success:function (data) {
//                   layer.alert(data.msgConfig)
                   getLimitData(1,15)
               },
               error:function (data) {
                   layer.alert(data.msg)
               }
           })
       }
   }
   function add(){
       limitIndex=layer.open({
           type: 1,
           area: ['552px', '502px'],
           title:'新建权限操作',
           maxmin: true,
           content: '<div id="form"></div>'
       });
       layui.laytpl($("#fieldTemplate").html()).render({}, function(html){
           $("#form").html(html);
           ajax("/manage/limit/type/all","post",{}).then(data=>{
             data.obj.forEach(function(item){

                  if(item.status==1){
                      $("#limitType").append("<option value='"+item.id+"'>"+"</option>");
                  }else{
                      $("#limitType").append("<option value='"+item.id+"'>"+item.name+"</option>");
                  }


             })

             layui.form.render();

           })

       })


   }
   function edit(data) {
       limitIndex = layer.open({
           type: 1,
           area: ['552px', '502px'],
           title:'修改权限操作',
           maxmin: true,
           content: '<div id="form"></div>'
       });
       layui.laytpl($("#fieldTemplate").html()).render({system:data.system}, function(html){
           $("#form").html(html);
           layui.form.val('editForm', data);
       })
   }

   //监听操作列工具条
   layui.table.on('tool(test)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
       var data = obj.data; //获得当前行数据
       var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
       var tr = obj.tr; //获得当前行 tr 的DOM对象

       if(layEvent === 'del'){ //删除
           layer.alert("确定删除:["+data.name+"]",function(){
              delById(data.id)
           })
        }
       else if(layEvent === 'edit'){ //编辑
          edit(data)
       }else if(layEvent === 'changeStatus'){ //编辑
           changeStatus(data);

       }
   });

</script>
<script type="text/html" id="sys">
  {{#if(d.system===1){ }}
  系统定义
  {{#} else if(d.system===0){ }}
  用户定义
  {{#} }}
</script>
