<title>消息通知</title>
<style>
  #nav span,.right span{display: none;}
  #nav a{display: inline-block;width: 40px;height: 35px;text-align: center;border: 1px solid #f5f5f5;}
  #nav a:nth-of-type(3){display: inline-block;width: 170px;height: 35px; text-align: left;padding-left: 20px;border-top: 2px solid #000;font-weight: bold;}
  .right{display: inline-block;position: absolute;top: 0;right: 0;}
  .layui-breadcrumb a{color: #000!important;}
  .layui-table-link:hover{color: #009688!important;}
  .layui-card-header p{margin-top: 10px;margin-left: 10px;}
  .layui-form-item .layui-input-block{display: inline-block;margin-left: -5px;}
  th .layui-table-cell{text-align: center}
</style>
<div class="layadmin-pagetabs" id="LAY_app_tabs">
  <div class="layui-icon layadmin-tabs-control layui-icon-prev" layadmin-event="leftPage"></div>
  <div class="layui-icon layadmin-tabs-control layui-icon-next" layadmin-event="rightPage"></div>
  <div class="layui-icon layadmin-tabs-control layui-icon-down">
    <ul class="layui-nav layadmin-tabs-select" lay-filter="layadmin-pagetabs-nav">
      <li class="layui-nav-item" lay-unselect="">
        <a href="javascript:;"><span class="layui-nav-more"></span></a>
        <dl class="layui-nav-child layui-anim-fadein">
          <dd layadmin-event="closeThisTabs"><a href="javascript:;">关闭当前标签页</a></dd>
          <dd layadmin-event="closeOtherTabs"><a href="javascript:;">关闭其它标签页</a></dd>
          <dd layadmin-event="closeAllTabs"><a href="javascript:;">关闭全部标签页</a></dd>
        </dl>
      </li>
      <span class="layui-nav-bar"></span></ul>
  </div>
  <div class="layui-tab" lay-unauto="" lay-allowclose="true" lay-filter="layadmin-layout-tabs">
    <ul class="layui-tab-title" id="LAY_app_tabsheader">
      <li lay-id="home/console.html" lay-attr="home/console.html" class=""><i class="layui-icon layui-icon-home"></i><i class="layui-icon layui-unselect layui-tab-close">ဆ</i></li>
      <li lay-id="home/homepage1.html" lay-attr="home/homepage1.html" class=""><span>主页一</span><i class="layui-icon layui-unselect layui-tab-close">ဆ</i></li><li lay-id="home/homepage2.html" lay-attr="home/homepage2.html" class=""><span>主页二</span><i class="layui-icon layui-unselect layui-tab-close">ဆ</i></li><li lay-id="template/msgboard.html" lay-attr="template/msgboard.html" class=""><span>留言板</span><i class="layui-icon layui-unselect layui-tab-close">ဆ</i></li><li lay-id="template/search.html" lay-attr="template/search.html" class="layui-this"><span>搜索结果</span><i class="layui-icon layui-unselect layui-tab-close">ဆ</i></li></ul>
  </div>
</div>
<div class="layui-fluid">
    <div class="layui-card h100"id="index">
      <div class="layui-card-body">
        <div class="layui-card-header" style="    height: 50px;display: inline-block;width: 100%;padding: 0;">
          <div class="layui-btn-container" style="display: inline-block;">
            <button class="layui-btn" data-method="delNews">删除</button>
            <button class="layui-btn" data-method="setRead">标记已读</button>
            <button class="layui-btn" data-method="allRead">全部已读</button>
<!--
            <button class="layui-btn" data-method="selectExport">标记导出</button>
-->
            <button class="layui-btn" onclick="doexport()">导出</button>
          </div>
          <form class="layui-form" style="float: right;">
           <div class="layui-form-item" style="float: left;">
              <div class="layui-input-block" style="width: 75px;">
                <select name="" id="">
                  <option value="" selected>全部</option>
                </select>
              </div>
              <div class="layui-input-block" style="    width: 240px;">
                <input id="newsContent" type="text" name="title" placeholder="内容" autocomplete="off" class="layui-input">
              </div>
              <div class="layui-input-block">
                <button class="layui-btn" type="button" onclick="getUserNews(1,10)" style="width: 50px;margin-top: -3px;"><i class="layui-icon">&#xe615;</i></button>
              </div>
            </div>
          </form>
        </div>
        <table id="test" lay-filter="test"></table>
        <div id="demo8"></div>
      </div>
    </div>
    <div class="layui-card" style="height:348px;display:none" id="detail">
        <div class="layui-card-header" style="height: 60px;line-height: 15px;padding-top: 10px;">
            <table>
                <tbody>
                <tr style="color: #333333">
                    <td>标题：</td>
                    <td id="newstitle"></td>
                </tr>
                <tr style="color: #999;font-size:14px;">
                    <td>发送时间：</td>
                    <td id="sendTime"></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="layui-card-body">
            <tbody>
            <table>
                <tr style="margin-left:10px;line-height:40px;">
                    <td>消息内容：</td>
                    <td id="newscontext"></td>
                </tr>
                </tbody>
            </table>
        </div>
        <button class="layui-btn layui-btn-primary" style=" margin-left: 10px;" onclick="returnBack()">返回上一级</button>
    </div>
</div>

<script type="text/html" id="titleTpl">
  {{#  if(d.status === 1){ }}
  <a href="javascript:void(0);" class="layui-table-link" style="color:#000" onclick='goList("{{d.id}}")'>{{d.content}}</a>
  {{#  } else if(d.status === 0){ }}
  <a href="javascript:void(0);" class="layui-table-link" style="color:#000" onclick='goList("{{d.id}}")'>{{d.content}}
    <span style='display:inline-block;width:38px;height:22px;background:red;float:right;color:#fff;line-height:22px;text-align:center;margin-top:3px;'>未读</span>
  </a>
  {{#  } }}

</script>
<script>

  $(function () {
      getUserNews(1,10);
  })

  //导出消息
  function doexport() {
      window.location.href="/manage/msg/downloadExcel?current=1&size=10";
  }
  //获取当前用户收到的消息
  function getUserNews(pageNo,size){
      var jsondata={
          "pager":{
              "current":pageNo,
              "size":size,
              "sortProps": [
              {
                "key": "status",
                "value": true
              },
              {
                "key": "sendTime",
                "value": false
              }
            ]
          },
          "entity":{
              "receptionId":-1,
              "content":document.getElementById("newsContent").value
          }
      }
      ajax("/manage/msg/list","post",JSON.stringify(jsondata)).then(data => {
          var res =data.obj.records;
          layui.use(['table','laypage'],function () {
              var table=layui.table,
                  laypage=layui.laypage;
              table.render({
                  elem:"#test",
                  data:data.obj.records,
                  cols: [[
                      {type:'checkbox'}
                      ,{field:'title',  title:'标题', align:'left' }
                      ,{field:'content', title: '标题内容', event: 'setSign',templet: '#titleTpl',align:"left"}
                      ,{field:'msgSign', title:'消息源类型',align:'left'}
                      ,{field:'sendUserName', title: '发件人',align:"left"}
                      ,{field:'sendTime', title: '接收时间',align:"left"}
                  ]]
              });
              laypage.render({
                  elem:'demo8'
                  ,count:data.obj.total
                  ,curr:data.obj.current
                  ,limit:data.obj.size
                  ,layout:['count','prev','page','next','limit','refresh','skip']
                  ,jump:function (obj,first) {
                      if (!first){
                          pageNo=obj.curr
                          size=obj.limit
                          getUserNews(pageNo,size)
                      }
                  }
              })
          })
      })
  }
  function goList(id){
      document.getElementById('index').style.display='none';
      document.getElementById('detail').style.display='block';
      getListObj(id).then(res=>{
          console.log(res.obj);
          showListObj(res.obj);
          if (res.obj.status == 0){
              var jsondata={
                  "status":1,
                  "ids":id
              }
              $.ajax({
                  type:"POST",
                  url:"/manage/msg/updateStatus",
                  contentType:"application/json",
                  data:JSON.stringify(jsondata),
                  dataType:"json"
              })
          }
      });
  }
  //根据id查询数据
  function getListObj(id) {
      return new Promise((resovle, reject) => {
          ajax("/manage/msg"+"/"+id,"get",{}).then(res=>{
              resovle(res);
          }).catch(res=>{
              reject(res);
          })
      })
  }
  function showListObj(obj){
      $("#newstitle").text(obj.title);
      $("#sendTime").text(obj.sendTime);
      $("#newscontext").text(obj.content);
      $('#detail').show();
  }
  function returnBack(){
      document.getElementById('index').style.display='block';
      document.getElementById('detail').style.display='none';
      getUserNews(1,10);
  }
  layui.use('table', function(){
    var table = layui.table;
    // 触发事件
      var active = {
          delNews: function () {
              var checkStatus=table.checkStatus("test"),
                  data=checkStatus.data;
              var ids="";
              for (var i in data){
                  ids=ids+data[i].id;
                  if(i<data.length-1){
                      ids=ids+",";
                  }
              }
              if (ids.length===0){
                  layer.alert('请选择要删除的消息')
                  return
              }
              if (confirm("是否确定删除,该操作不可撤回")){
                  var dataIds={
                      "ids":ids
                  };
                  $.ajax({
                      type:"GET",
                      url:"/manage/msg/delByIds",
                      contentType:"application/json",
                      data:dataIds,
                      dataType:"json",
                      success:function (data) {
                          layer.alert(data.msg)
                          getUserNews(1,10)
                      },
                      error:function (data) {
                          layer.alert(data.msg)
                      }
                  })
              }

          },
          //标记已读
          setRead:function () {
              var checkStatus=table.checkStatus("test"),
                  data=checkStatus.data;
              var idStr="";
              //console.log(data.length)
              if (data.length===0){
                  layer.alert("请选择标记数据");
                  return false;
              }
              for(var i in data){
                  idStr=idStr+data[i].id;
                  if(i<data.length-1){
                      idStr=idStr+",";
                  }
              }
              var jsondata={
                  "status":1,
                  "ids":idStr
              }
              ajax("/manage/msg/updateStatus","post",JSON.stringify(jsondata)).then(data => {
                  layer.alert("标记成功")
                  getUserNews(1,10)
              })
          },
          //全部已读
          allRead: function () {
              layer.alert("是否标记全部已读",function(){
                  ajax2("/manage/msg/setAllRead","post",{}).then(data => {
                      layer.alert("标记成功")
                      getUserNews(1,10)
                  })
              })
          },
          //标记已读
          selectExport:function () {
              var checkStatus=table.checkStatus("test"),
                  data=checkStatus.data;
              var idStr="";
              //console.log(data.length)
              if (data.length===0){
                  layer.alert("请选择导出数据");
                  return false;
              }
              for(var i in data){
                  idStr=idStr+data[i].id;
                  if(i<data.length-1){
                      idStr=idStr+",";
                  }
              }
              var jsondata={
                  "ids":idStr
              }
              $.ajax({
                  type:"POST",
                  url:"/manage/msg/downloadExcel?current=1&size=10",
                  contentType:"application/json",
                  data:JSON.stringify(jsondata),
                  dataType:"json",
                  success:function (data) {
                      layer.alert("标记成功")
                      getUserNews(1,10)
                  },
                  error:function (data) {
                      layer.alert("标记失败")
                  }
              })
          }
      }
      table.on('tool(test)', function(obj) {
          var data = obj.data;
          goList();
          //标注选中样式
          obj.tr.addClass('layui-table-click').siblings().removeClass('layui-table-click');
      })


      $(document).on('click', '.layui-btn',function(){
          var othis = $(this), method = othis.data('method');
          active[method] ? active[method].call(this, othis) : '';
      });

  });

  layui.form.render();
</script>