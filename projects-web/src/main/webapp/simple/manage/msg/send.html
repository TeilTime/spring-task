<title>已发消息</title>
<style>
    #nav span,.right span{display: none;}
    #nav a{display: inline-block;width: 40px;height: 56px;text-align: center;border: 1px solid #f5f5f5;}
    #nav a:nth-of-type(3){display: inline-block;width: 170px;height: 52px; text-align: left;padding-left: 20px;border-top: 2px solid #000;font-weight: bold;}
    .right{display: inline-block;position: absolute;top: 0;right: 0;}
    .layui-breadcrumb a{color: #000!important;}
    .layui-table-header,.layui-table-view,.layui-table-box{overflow: visible;}
    .layui-table-link:hover{color: #009688!important;}
    .layui-card-header p{margin-top: 10px;margin-left: 10px;}
    .layui-form-item .layui-input-block{display: inline-block;margin-left: -5px;}
    #select .layui-form-select{width: 327px;}
    label span{color: red; margin-right: 5px;}
    .layui-transfer-header{position: relative;}
    .layui-transfer-box:first-of-type{width: 410px!important;}
    .layui-transfer-box:last-of-type{width: 360px!important;}
    .layui-transfer-header{background: #009688;line-height: 38px;}
    .layui-transfer-header .layui-form-checkbox[lay-skin=primary] span{margin-left: 30px; display: inline-block;height: 38px;line-height: 36px; color: #fff!important;}
    .layui-form-checkbox[lay-skin=primary] span{margin-left: 30px; display: inline-block;height: 38px;line-height: 36px;}
    .layui-form-checkbox[lay-skin=primary] span:first-of-type{margin-left: 0px;}
    .layui-transfer-box .layui-form-checkbox i{top: 10px;}
    li .layui-form-checkbox[lay-skin=primary] div span:nth-of-type(1){width: 80px;}
    li .layui-form-checkbox[lay-skin=primary] div span:nth-of-type(2){width: 80px; margin-left: 45px;}
    th .layui-table-cell{text-align: center}
    .send_table_div{width:270px;float:left;margin-right:10px;}
</style>
<div class="layui-card layadmin-header">
    <div class="layui-breadcrumb" lay-filter="breadcrumb" id="nav">
      <a><i class="layui-icon layui-icon-prev"></i></a>
      <a lay-href=''><i class="layui-icon layui-icon-home"></i></a>
      <a>已发消息<i class="layui-icon layui-icon-close" style="margin-left: 50px"></i></a>
      <div class="right">
        <a><i class="layui-icon layui-icon-next"></i></a>
        <a><i class="layui-icon layui-icon-down"></i></a>
      </div>
    </div>
</div>
<div class="layui-fluid">
    <div class="layui-card h100"  id="index">
        <div class="layui-card-body">
            <div class="layui-btn-container" style="display: inline-block;">
                <button class="layui-btn" data-type="add">新建消息</button>
                <button class="layui-btn" onclick="delSendNews()">删除</button>
                <button class="layui-btn" onclick="doexport()">导出</button>
            </div>
            <form class="layui-form" style="float: right;margin-right:60px;">
                <div class="layui-form-item">
                    <div class="layui-input-block" style="width: 75px;">
                        <select name="" id="">
                            <option value="" selected>全部</option>
                        </select>
                    </div>
                    <div class="layui-input-block">
                        <input id="newsContent" type="text" name="title" placeholder="内容" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </form>
            <button onclick="getSendNews(1,10)" class="layui-btn" style="display: inline-block;float:right;margin-right: -308px;"><i class="layui-icon">&#xe615;</i></button>
            <table id="test" lay-filter="test"></table>
            <div id="demo8"></div>
        </div>
    </div>
    <div class="layui-card" style="height:348px;display:none" id="detail">
        <div class="layui-card-header" style="height: 60px;line-height: 15px;padding-top: 10px;">
            <table>
                <tbody>
                    <tr style="color: #333333">
                        <td>标题：</td>
                        <td id="newstitle"></td>
                    </tr>
                    <tr style="color: #999;font-size:14px;">
                        <td>发送时间：</td>
                        <td id="sendTime"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="layui-card-body">
            <tbody>
                <table>
                    <tr style="margin-left:10px;line-height:40px;">
                        <td>消息内容：</td>
                        <td id="newscontext"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <button class="layui-btn layui-btn-primary" style=" margin-left: 10px;" onclick="returnBack()">返回上一级</button>
    </div>
</div>

<script type="text/html" id="titleTplSend">
    <a href="javascript:void(0);" class="layui-table-link" style="color:#000" onclick='goSend("{{d.id}}")'>{{d.content}}</a>
</script>
<script type="text/html" id="sendMsgTpl">
    <form class='layui-form' id="addNews">
        <div class="layui-form-item" style='margin-top:10px;'>
            <label class="layui-form-label"><span>*</span>消息标题</label>
            <div class="layui-input-block">
                <input type="text" name="title" required autocomplete="off" placeholder="请输入" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label"><span>*</span>消息类型</label>
            <div class="layui-input-block" id='select'>
                <select class="layui-input" lay-verify="required" id="msgConfig" name="configId" >
            </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label"><span>*</span>消息内容</label>
            <div class="layui-input-block">
              <textarea style="width:875px;height: 315px;" id="msgContent" name="content" required placeholder="请输入描述" class="layui-textarea"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label"><span>*</span>发送范围</label>
            <div class="layui-input-block">
                <input type="checkbox" checked="" name="open" lay-skin="switch" lay-filter="switchTest" lay-text="ON|OFF">
                <input type="checkbox" value="1" lay-filter="choiceBox" class="choiceBox" disabled lay-skin="primary"><span>选择组织</span>
                <input type="checkbox" value="2" lay-filter="choiceBox" class="choiceBox" disabled lay-skin="primary"><span>选择角色</span>
                <input type="checkbox" value="3" lay-filter="choiceBox" class="choiceBox" disabled lay-skin="primary"><span>选择用户</span>
            </div>
            <!--<div class="layui-input-block">
                <input id="person" readonly="readonly" type="text" name="title" lay-verify="title" autocomplete="off" placeholder="请输入" class="layui-input" style='width:250px;display:inline-block;border:none;border-right:1px solid #D2D2D2;'>
                <button type="button" class="layui-btn layui-btn-primary" style='display:inline-block;width:76px!important;border:none;background:rgba(245, 247, 250, 1);margin-left:-3px' data-type='selectPerson'>选择...</button>
            </div>-->
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label"></label>
            <div class="layui-input-block">
                <div class="send_table_div">
                    <table id="sendToGroupTable" lay-filter="sendToGroupTable" ></table>
                </div>
                <div class="send_table_div">
                    <table id="sendToRoleTable" lay-filter="sendToRoleTable"></table>
                </div>
                <div class="send_table_div">
                    <table id="sendToUserTable" lay-filter="sendToUserTable" ></table>
                </div>
            </div>
        </div>
        <input type="hidden" id="ids" name="ids">
        <div class='button-bar'>
            <button class='layui-btn' type="button" onclick="addSends()">确定</button>
            <button class="layui-btn" type="button" data-type="close">取消</button>
        </div>
    </form>
</script>
<script type="text/html" id="selectUserTpl">
    <form action="#" class='layui-form' style='display:inline-block'>
        <div class='layui-form-item'>
            <div class='layui-input-block' style='display:inline-block;position:absolute;top:12px;width:150PX;'>
                <select name="id" id="company">
                    <option value="" selected>请选择组织</option>
                </select>
            </div>
            <div class="layui-input-block" style='margin-top:10px;height:38px;width:193px;overflow:hidden;border:1px solid #D2D2D2;border-radius:2px;display:inline-block;margin-left:170px;'>
                <input type="text" id="titleId" name="title" lay-verify="title" autocomplete="off" placeholder="请输入" class="layui-input" style='width:146px;display:inline-block;border:none;border-right:1px solid #D2D2D2;'>
                <button type="button" class="layui-btn layui-btn-primary" style='display:inline-block;width:46px!important;border:none;background:rgba(245, 247, 250, 1);margin-left:-3px;padding:0' onclick="searchPeople()">搜索</button>
              </div>
        </div>
    </form>
    <div style='display:inline-block;margin-left:120px;position:absolute;top:20px;font-weight:700px;'>
       已选中用户列表
    </div>
    <div id="test1"></div>
    <div class='button-bar'>
        <button class='layui-btn' onclick="getSelectUser()">确定</button>
        <button class='layui-btn' onclick="layer.closeAll()">取消</button>
    </div>
</script>
<script type="text/html" id="selectGrpTpl">
    <form action="#" class='layui-form' style='display:inline-block'>
        <div class='layui-form-item'>
            <div class='layui-input-block' style='display:inline-block;position:absolute;top:12px;width:150PX;'>
                <select name="id" id="companys">
                    <option value="" selected>请选择机构</option>
                </select>
            </div>
            <div class="layui-input-block" style='margin-top:10px;height:38px;width:193px;overflow:hidden;border:1px solid #D2D2D2;border-radius:2px;display:inline-block;margin-left:170px;'>
                <input type="text" id="titleId1" name="title" lay-verify="title" autocomplete="off" placeholder="请输入" class="layui-input" style='width:146px;display:inline-block;border:none;border-right:1px solid #D2D2D2;'>
                <button type="button" class="layui-btn layui-btn-primary" style='display:inline-block;width:46px!important;border:none;background:rgba(245, 247, 250, 1);margin-left:-3px;padding:0' onclick="searchPeople()">搜索</button>
            </div>
        </div>
    </form>
    <div style='display:inline-block;margin-left:120px;position:absolute;top:20px;font-weight:700px;'>
        已选中组织列表
    </div>
    <div id="test2"></div>
    <div class='button-bar'>
        <button class='layui-btn' onclick="getSelectGrp()">确定</button>
        <button class='layui-btn' onclick="layer.closeAll()">取消</button>
    </div>
</script>
<script type="text/html" id="selectRoleTpl">
    <form action="#" class='layui-form' style='display:inline-block'>
        <div class='layui-form-item'>
            <div class='layui-input-block' style='display:inline-block;position:absolute;top:12px;width:150PX;'>
                <select name="id" id="companys1">
                    <option value="" selected>请选择机构</option>
                </select>
            </div>
            <div class="layui-input-block" style='margin-top:10px;height:38px;width:193px;overflow:hidden;border:1px solid #D2D2D2;border-radius:2px;display:inline-block;margin-left:170px;'>
                <input type="text" id="titleId2" name="title" lay-verify="title" autocomplete="off" placeholder="请输入" class="layui-input" style='width:146px;display:inline-block;border:none;border-right:1px solid #D2D2D2;'>
                <button type="button" class="layui-btn layui-btn-primary" style='display:inline-block;width:46px!important;border:none;background:rgba(245, 247, 250, 1);margin-left:-3px;padding:0' onclick="searchPeople()">搜索</button>
            </div>
        </div>
    </form>
    <div style='display:inline-block;margin-left:120px;position:absolute;top:20px;font-weight:700px;'>
        已选中角色列表
    </div>
    <div id="test3"></div>
    <div class='button-bar'>
        <button class='layui-btn' onclick="getSelectRole()">确定</button>
        <button class='layui-btn' onclick="layer.closeAll()">取消</button>
    </div>
</script>
<script>
    $(function () {
        getSendNews(1,10);
    })

    var selectPsersonIndex;

    var selectGroupIndex;

    var selcetRoleIndex;

    var addIndex;

    var defaultSize = 15;
    var sendUsers = [];
    var sendRoles = [];
    var sendGrps=[];

    function addSends() {

        var jsondata=$("#addNews").serialize();
        jsondata=decodeURIComponent(jsondata,true);//防止中文乱码
        jsondata=jsondata.replace(/&/g,"\",\"");
        jsondata=jsondata.replace(/=/g,"\":\"");
        jsondata="{\""+jsondata+"\"}";
        var i;
        var list = new Array();
        for(i=0;i<sendUsers.length;i++){
            list.push(sendUsers[i].id);
        }
        for(i=0;i<sendRoles.length;i++){
            list.push(sendRoles[i].id)
        }
        for(i=0;i<sendGrps.length;i++){
            list.push(sendGrps[i].id);
        }
        var obj =JSON.parse(jsondata);
        obj.ids= list.toString();
        jsondata = JSON.stringify(obj);
        console.log(jsondata);

        $.ajax({
            type:"post",
            url:"/manage/msg/addSends",
            contentType:"application/json",
            data:jsondata,
            dataType:"json",
            success:function (data) {

                layer.alert(data.msg)
                layer.close(addIndex);
                getSendNews(1,10);
            },
            error:function (data) {
                console.log("xx")
            }
        })
    }

    function getMsgConfig() {
        var jsondata = {
            "pager": {
                "current": 1,
                "size": defaultSize
            }
            ,"entity": {
                "mark":9,
                "name": $('#nameId').val()
            }
        }
        $.ajax({
            type: "post",
            url: "/config/msg/list",
            contentType: "application/json",
            data: JSON.stringify(jsondata),
            dataType: "json",
            success: function (data) {
                var records = data.obj.records;
                var msgConfig;
                for(var i in records){
                    msgConfig += '<option value="'+records[i].id+'">'+records[i].name+' </option>'
                }
                $("#msgConfig").append(msgConfig);
                layui.form.render();
            },
            error: function (data) {
                console.log(data.msg)
            }
        })
    }


    function getSelectUser() {
        layui.use('transfer',function () {
            var transfer=layui.transfer;
            var selData=transfer.getData('demo1');
            console.log(selData);
            var datas=[];
            for (var i=0;i< selData.length;i++){
                datas.push(selData[i].data);
            }
            sendUsers = datas;
            layui.table.reload("sendToUserTable",{
                data:datas
            });
            layer.close(selectPsersonIndex);
        })


    }
    function getSelectGrp() {
        layui.use('transfer',function () {
            var transfer=layui.transfer;
            var selData=transfer.getData('demo2');
            var datas=[];
            for (var i=0;i< selData.length;i++){
                datas.push(selData[i].data);
            }
            sendGrps = datas;
            layui.table.reload("sendToGroupTable",{
                data:datas
            });
            layer.close(selectGroupIndex);
        })


    }
    function getSelectRole() {
        layui.use('transfer',function () {
            var transfer=layui.transfer;
            var selData=transfer.getData('demo3');
            var datas=[];
            for (var i=0;i< selData.length;i++){
                datas.push(selData[i].data);
            }
            sendRoles=datas;
            layui.table.reload("sendToRoleTable",{
                data:datas
            });
            layer.close(selcetRoleIndex);
        })


    }
    //导出消息
    function doexport() {
        window.location.href="/manage/msg/downloadExcel?current=1&size="+defaultSize;
    }
    function  getSendNews(pageNo) {
          var jsondata={
              "pager":{
                  "current":pageNo,
                  "size":defaultSize,
                  "sortProps":{
                      key:"sendTime",
                      value: false
                  }
              },
              "entity":{
                  "sendID":-1,
                  "content":document.getElementById("newsContent").value
              }
          }
          $.ajax({
              type:"POST",
              url:"/manage/msg/list",
              contentType:"application/json",
              data:JSON.stringify(jsondata),
              dataType:"json",
              success:function (data) {
                  layui.use(['table','laypage'],function () {
                      var table=layui.table,
                          laypage=layui.laypage;
                      table.render({
                          elem:"#test",
                          data:data.obj.records,
                          cols: [[
                              {type:'checkbox'}
                              ,{field:'title', width:400, title:'标题', align:'left' }
                              ,{field:'content', width:650, title: '内容', event: 'setSign',templet: '#titleTplSend',align:"left"}
                              ,{field:'msgSign',width:170,title:'消息源类型',align:'left'}
                              ,{field:'receptUserName', width:205, title: '收件人',align:'left'}
                              ,{field:'sendTime', width:160, title: '发送时间',align:'left'}
                          ]]
                      });
                      laypage.render({
                          elem:'demo8'
                          ,count:data.obj.total
                          ,curr:data.obj.current
                          ,limit:defaultSize
                          ,layout:['count','prev','page','next','limit','refresh','skip']
                          ,jump:function (obj,first) {
                              if (!first){
                                  pageNo=obj.curr
                                  getSendNews(pageNo)
                              }
                          }
                      })
                  })
              },
              error:function (data) {
                  layer.alert(data.msg)
              }
          })
    }
    function goSend(id){
        document.getElementById('index').style.display='none';
        document.getElementById('detail').style.display='block';
        getSendObj(id).then(res=>{
            showSendObj(res.obj);
        });
    }
    //根据id查询数据
    function getSendObj(id) {
        return new Promise((resovle, reject) => {
            ajax("/manage/msg"+"/"+id,"get",{}).then(res=>{
                resovle(res);
            }).catch(res=>{
                reject(res);
            })
        })
    }
    function showSendObj(obj){
        $("#newstitle").text(obj.title);
        $("#sendTime").text(obj.sendTime);
        $("#newscontext").text(obj.content);
        $('#detail').show();
    }
    function returnBack(){
        document.getElementById('index').style.display='block';
        document.getElementById('detail').style.display='none';
    }
    function add(){
        addIndex=layer.open({
            type: 1,
            area: ['1030px', '900px'],
            title:'新建消息',
            maxmin: true,
            content: '<div id="fieldForm"></div>'
        });
        getMsgConfig();

        layui.laytpl($("#sendMsgTpl").html()).render({}, function(html){
            $("#fieldForm").html(html);
            /*UE.getEditor('msgContent',{
                //这里可以选择自己需要的工具按钮名称,此处仅选择如下五个
                toolbars:[['FullScreen', 'Source', 'Undo', 'Redo','Bold','test']],
                //focus时自动清空初始化时的内容
                autoClearinitialContent:true,
                //关闭字数统计
                wordCount:false,
                //关闭elementPath
                elementPathEnabled:false,
                //默认的编辑区域高度
                initialFrameHeight:300
                //更多其他参数，请参考ueditor.config.js中的配置项
            })*/
            layui.table.render({
                elem:"#sendToGroupTable",
                data:[],
                cols: [[
                    {type: 'numbers', title:'序号'}
                    ,{field:'name', title: '组织名', align:"left"}
                    ,{field:'companyName', title:'所属机构',align:'left'}
                ]]
                ,limit:5
                ,page:{
                    layout: ['prev', 'page', 'next'] //自定义分页布局
                }
            });
            layui.table.render({
                elem:"#sendToRoleTable",
                data:[],
                cols: [[
                    {type: 'numbers', title:'序号'}
                    ,{field:'name', title: '角色名', align:"left"}
                    ,{field:'companyName', title:'所属机构',align:'left'}
                ]]
            });
            layui.table.render({
                elem:"#sendToUserTable",
                data:[],
                cols: [[
                    {type: 'numbers', title:'序号'}
                    ,{field:'name', title: '用户名', align:"left"}
                    ,{field:'groupName', title:'所属机构',align:'left'}
                ]]
                ,limit:5
                ,page:{
                    layout: ['prev', 'page', 'next'] //自定义分页布局
                }
            });
            layui.table.render({
                elem:"#sendToRoleTable",
                data:[],
                cols: [[
                    {type: 'numbers', title:'序号'}
                    ,{field:'name', title: '用户名', align:"left"}
                    ,{field:'companyName', title:'所属机构',align:'left'}
                ]]
                ,limit:5
                ,page:{
                    layout: ['prev', 'page', 'next'] //自定义分页布局
                }
            });
            layui.table.render({
                elem:"#sendToUserTable",
                data:[],
                cols: [[
                    {type: 'numbers', title:'序号'}
                    ,{field:'name', title: '用户名', align:"left"}
                    ,{field:'groupName', title:'所属机构',align:'left'}
                ]]
                ,limit:5
                ,page:{
                    layout: ['prev', 'page', 'next'] //自定义分页布局
                }
            });
            layui.form.render();
        })
    }

    //删除
    function delSendNews() {
        var checkStatus=layui.table.checkStatus("test"),
            data=checkStatus.data;
        var ids="";
        for (var i in data){
            ids=ids+data[i].id;
            if(i<data.length-1){
                ids=ids+",";
            }
        }
        if (ids.length===0){
            layer.alert('请选择要删除的消息')
            return
        }
        layer.alert("是否确定删除,该操作不可撤回",function(){
            var dataIds={
                "ids":ids
            };
            $.ajax({
                type:"GET",
                url:"/manage/msg/delByIds",
                contentType:"application/json",
                data:dataIds,
                dataType:"json",
                success:function (data) {
                    layer.closeAll();
                    getSendNews(1,10);
                },
                error:function (data) {
                    layer.alert(data.msg)
                }
            })
        })
    }

    //选择框搜索
    function searchPeople() {
        var nameValue = $("#titleId").val();
        var jsondata={
            "entity":{

                "groupId":$('#groups option:selected').val(),

                "name": nameValue
            }
        };
        $.ajax({
            type:"POST",
            url:"/manage/user/getUser",
            contentType:"application/json",
            data:JSON.stringify(jsondata),
            dataType:"json",
            success:function (data) {
                layui.laytpl($("#selectUserTpl").html()).render({}, function(html){
                    $("#fieldForm1").html(html);
                    ajax("/manage/group/list","post",JSON.stringify({pager:{current:1,size:defaultSize}})).then(res=>{
                        var records = res.obj.records;
                        var groups;
                        for(var i in records){
                            groups += '<option value="'+records[i].id+'">'+records[i].name+'</option>'
                        }
                        $("#groups").append(groups);
                        layui.form.render();
                    });
                    layui.form.render();
                    layui.use('transfer', function(){
                        var transfer = layui.transfer;
                        //渲染
                        var result=[];
                        for (var i=0;i<data.obj.records.length;i++){
                            result.push({"value":data.obj.records[i].id,"title":"<div><span>"+data.obj.records[i].name+"</span><span>"+data.obj.records[i].trueName+"</span><span>"+data.obj.records[i].groupName+"</span></div>","disabled": "", "checked": ""})
                        }
                        transfer.render({
                            elem: '#test1'  //绑定元素
                            ,title:['<div><span>用户</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>真实姓名</span><span>所属机构</span></div>','<div><span>用户</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>真实姓名</span><span>所属机构</span></div>']
                            ,data:result
                            ,id:"demo1"
                        });
                    });
                })
            },
            error:function (data) {
                console.log("出错了")
            }
        });

    }
    function selectPerson(){
        selectPsersonIndex = layer.open({
            type: 1,
            area: ['950px', '521px'],
            title:'选择用户',
            maxmin: true,
            content: '<div id="fieldForm1" style="    padding-left: 50px;"></div>'
        });

        var jsondata={
            "entity": {
                "name": ""
            }
        };

        //查询数据
        $.ajax({
            type:"POST",
            url:"/manage/user/getUser",
            contentType:"application/json",
            data:JSON.stringify(jsondata),
            dataType:"json",
            success:function (data) {
                layui.laytpl($("#selectUserTpl").html()).render({}, function(html){
                    $("#fieldForm1").html(html);
                    ajax("/manage/company/list","post",JSON.stringify({pager:{current:1,size:defaultSize}})).then(res=>{
                        var records = res.obj.records;
                        var company;
                        for(var i in records){
                            company += '<option value="'+records[i].id+'">'+records[i].name+'</option>'
                        }
                        $("#company").append(company);
                        layui.form.render();
                    });
                    layui.use('transfer', function(){
                        var transfer = layui.transfer;
                        //渲染
                        var result=[];

                        for (var i=0;i<data.obj.records.length;i++){
                            result.push({"value":data.obj.records[i].id,"title":'<div><span>'+data.obj.records[i].name+'</span><span>'+data.obj.records[i].trueName+'</span><span>'+data.obj.records[i].groupName+'</span></div>',"disabled": "", "checked": "",data:data.obj.records[i]})
                        }
                        transfer.render({
                            elem: '#test1'  //绑定元素
                            ,title:['<div><span>用户</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>真实姓名</span><span>所属机构</span></div>','<div><span>用户</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>真实姓名</span><span>所属机构</span></div>']
                            ,data:result
                            ,id:"demo1"
                        });

                    });
                })
            },
            error:function (data) {
                console.log("出错了")
            }
        });
    }
    function selectGroup(){
        selectGroupIndex = layer.open({
            type: 1,
            area: ['950px', '521px'],
            title:'选择组织',
            maxmin: true,
            content: '<div id="fieldForm2" style="    padding-left: 50px;"></div>'
            }
        )
        var jsondata={
            "entity": {
                "name": ""
            },
            "pager": {
                "currNum": 0,
                "current": 1,
                "size": 1000
            }

        };

        //查询数据
        $.ajax({
            type:"POST",
            url:"/manage/group/list",
            contentType:"application/json",
            data:JSON.stringify(jsondata),
            dataType:"json",
            success:function (data) {
                console.log(data);
                layui.laytpl($("#selectGrpTpl").html()).render({}, function(html){
                    $("#fieldForm2").html(html);
                    ajax("/manage/company/list","post",JSON.stringify({pager:{current:1,size:defaultSize}})).then(res=>{
                        var records = res.obj.records;
                    var companys;
                    for(var i in records){
                        companys += '<option value="'+records[i].id+'">'+records[i].name+'</option>'
                    }
                    $("#companys").append(companys);

                    layui.form.render();
                });
                    layui.use('transfer', function(){
                        var transfer = layui.transfer;
                        //渲染
                        var result=[];

                        for (var i=0;i<data.obj.records.length;i++){
                            result.push({"value":data.obj.records[i].id,"title":"<div><span>"+data.obj.records[i].name+"</span><span>"+data.obj.records[i].companyName+"</span></div>","disabled": "", "checked": "",data:data.obj.records[i]})
                        }
                        transfer.render({
                            elem: '#test2'  //绑定元素
                            ,title:['<div><span>组织</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span></span><span>所属机构</span></div>','<div><span>组织</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span></span><span>所属机构</span></div>']
                            ,data:result
                            ,id:"demo2"
                        });

                    });
                })
            },
            error:function (data) {
                console.log("出错了")
            }
        });
    }

    function selectRole(){
        selcetRoleIndex = layer.open({
                type: 1,
                area: ['950px', '521px'],
                title:'选择角色',
                maxmin: true,
                content: '<div id="fieldForm3" style="    padding-left: 50px;"></div>'
            }
        )
        var jsondata={
            "entity": {
                "name": ""
            },
            "pager": {
                "currNum": 0,
                "current": 1,
                "size": 1000
            }

        };

        //查询数据
        $.ajax({
            type:"POST",
            url:"/manage/role/list",
            contentType:"application/json",
            data:JSON.stringify(jsondata),
            dataType:"json",
            success:function (data) {
                console.log(data);
                layui.laytpl($("#selectRoleTpl").html()).render({}, function(html){
                    $("#fieldForm3").html(html);
                    ajax("/manage/company/list","post",JSON.stringify({pager:{current:1,size:defaultSize}})).then(res=>{
                        var records = res.obj.records;
                    var companys1;
                    for(var i in records){
                        companys1 += '<option value="'+records[i].id+'">'+records[i].name+'</option>'
                    }
                    $("#companys1").append(companys1);

                    layui.form.render();
                });
                    layui.use('transfer', function(){
                        var transfer = layui.transfer;
                        //渲染
                        var result=[];

                        for (var i=0;i<data.obj.records.length;i++){
                            result.push({"value":data.obj.records[i].id,"title":"<div><span>"+data.obj.records[i].name+"</span><span>"+data.obj.records[i].companyName+"</span></div>","disabled": "", "checked": "",data:data.obj.records[i]})
                        }
                        transfer.render({
                            elem: '#test3'  //绑定元素
                            ,title:['<div><span>角色</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span></span><span>所属机构</span></div>','<div><span>角色</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span></span><span>所属机构</span></div>']
                            ,data:result
                            ,id:"demo3"
                        });

                    });
                })
            },
            error:function (data) {
                console.log("出错了")
            }
        });
    }

    layui.form.on('switch(switchTest)', function(data){
        $(".choiceBox").prop("disabled",this.checked);
        layui.form.render();
    });

    layui.form.on('checkbox(choiceBox)', function(data){
        if(this.checked){
            switch (Number($(this).val())) {
                case 1: selectGroup();break;
                case 2: selectRole();break;
                case 3: selectPerson(); break;
            }
        }
    });

    layui.form.render();
</script>