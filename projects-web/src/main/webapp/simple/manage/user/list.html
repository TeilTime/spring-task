<title>系统用户</title>

<style>
  .userForm .layui-tab{margin:0;}
  .userForm .layui-tab-title li{padding:0 35px;background-color: rgba(248, 248, 248, 1);}
  .userForm .layui-card{    width: 90%; margin: auto;}
  .userForm .layui-input{    width: 70%; float:left;}
  .userForm .layui-form-item{    margin-bottom: 10px;}
  .userForm .tipspan{font-size: 10px; line-height: 15px;}
  .userForm .button-bar{text-align: center;}
  .userForm .bitianspan {
    height: 40px;
    line-height: 40px;
    margin-left: 20px;
    color: #FF6600;
  }
  .layui-card-header.layuiadmin-card-header-auto{padding-top:10px;padding-bottom: 10px;}
  .right{background: url("./img/u6237.png") no-repeat;display: inline-block;width: 16px;height: 16px;}
  /*.layui-table-cell{text-align: center;}*/
  .node_name{color: #000000;}
  .layui-transfer-box{height: 400px!important;}
  /*.layui-transfer-header{background: rgba(0, 150, 136, 1);color:#fff;}*/
  #form .layui-edge{right: 125px;margin-top: 15px;}
  th .layui-table-cell{text-align: center}
</style>

<div class="layui-card layadmin-header">
  <div class="layui-breadcrumb" lay-filter="breadcrumb">
    <a lay-href="">主页</a>
    <a><cite>用户</cite></a>
    <a><cite>系统用户</cite></a>
  </div>
</div>

<div class="layui-fluid">
  <div class="layui-card h100">
    <div class="layui-form layui-card-header layuiadmin-card-header-auto" lay-filter="layadmin-useradmin-formlist">
      <form class="layui-form">
        <div class="layui-form-item">
          <div class="layui-inline">
            <label class="layui-form-label">用户名</label>
            <div class="layui-input-block">
              <input type="text" name="name" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
          </div>
          <div class="layui-inline">
            <label class="layui-form-label">真实姓名</label>
            <div class="layui-input-block">
              <input type="text" name="trueName" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
          </div>
          <div class="layui-inline">
            <label class="layui-form-label">组织</label>
            <div class="layui-input-block">
              <select name="groupId" id="orgs">
                <option value="" selected disabled hidden>请选择</option>
              </select>
            </div>
          </div>
          <div class="layui-inline">
            <label class="layui-form-label">角色</label>
            <div class="layui-input-block">
              <select name="roleId" id="role">
                <option value="" selected disabled hidden>请选择</option>
              </select>
            </div>
          </div>
          <div class="layui-inline">
            <button class="layui-btn layuiadmin-btn-admin" lay-submit lay-filter="LAY-user-back-search">
              <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
            </button>
          </div>
        </div>
      </form>
    </div>

    <div class="layui-card-body">
      <div style="padding-bottom: 10px;">
        <button class="layui-btn layuiadmin-btn-admin" id="addUser" data-type="add">添加系统用户</button>
        <button class="layui-btn layuiadmin-btn-admin" data-type="del">删除系统用户</button>
      </div>
      <div style="height: 630px;">
        <table id="demo" lay-filter="demo"></table>
      </div>
      <div id="page"></div>
      <script type="text/html" id="buttonTpl">
        {{#  if(d.check == true){ }}
        <button class="layui-btn layui-btn-xs">已审核</button>
        {{#  } else { }}
        <button class="layui-btn layui-btn-primary layui-btn-xs">未审核</button>
        {{#  } }}
      </script>
      <script type="text/html" id="table-useradmin-admin">
        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
        {{#  if(d.role == '超级管理员'){ }}
        <a class="layui-btn layui-btn-disabled layui-btn-xs"><i class="layui-icon layui-icon-delete"></i>删除</a>
        {{#  } else { }}
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</a>
        {{#  } }}
      </script>
    </div>
  </div>
</div>

<!--表头工具模板-->
<script type="text/html" id="toolbarDemo">
  <div class="layui-btn-container">
    <button class="layui-btn layui-btn-sm" lay-event="add">添加</button>
    <button class="layui-btn layui-btn-sm" lay-event="delete">删除</button>
    <button class="layui-btn layui-btn-sm" lay-event="organ">添加组织</button>
    <button class="layui-btn layui-btn-sm" lay-event="role">添加角色</button>
    <!--<button class="layui-btn layui-btn-sm" lay-event="limit">添加权限</button>-->
    <button class="layui-btn layui-btn-sm" lay-event="open">开通</button>
    <button class="layui-btn layui-btn-sm" lay-event="logout">注销</button>
    <!--<button class="layui-btn layui-btn-sm" lay-event="import">批量导入</button>-->
  </div>
</script>

<!--操作列模板-->
<script type="text/html" id="barDemo">
  <!--<a class="layui-btn layui-btn-xs" lay-event="limit">授权</a>
  <a class="layui-btn layui-btn-xs" lay-event="detail">查看</a>-->
  <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>

<!--操作列模板-->
<script type="text/html" id="limitBar">
  <a class="layui-btn  layui-btn-primary layui-btn-xs" data-type="see" lay-event="limit">查看</a>
  <a class="layui-btn  layui-btn-primary layui-btn-xs"  data-type="see"  lay-event="limit">设置</a>
</script>

<!--弹出层模板（新增，查看，编辑）-->
<script type="text/html"  id="tableDataTemplate">
  <form class="layui-form" lay-filter="editForm">
  <div class="layui-tab">
    <!--<ul class="layui-tab-title" style="background: rgba(248, 248, 248, 1);">
      <li class="layui-this">添加用户</li>
      <li>所属组织</li>
      <li>系统角色</li>
      <li>特定角色</li>
      <li>其他信息</li>
    </ul>-->
    <div class="layui-tab-content" style="height: 585px;overflow: auto;">
      <div class="layui-tab-item layui-show">
          <div class="layui-card">
            <div class="layui-card-body">
              <div class="layui-form-item">
                <label class="layui-form-label">用户名:</label>
                <div class="layui-input-block">
                  <input type="text" name="name" lay-verify="userName" placeholder="请输入" autocomplete="off" class="layui-input">
                  <span class="bitianspan">必填</span>
                </div>
              </div>
              <div class="layui-form-item">
                <label class="layui-form-label"></label>
                <div class="layui-input-block">
                  <span class="tipspan">
                    用户登录名填写规则：<br>
                    1）英文字母(不区分大小写)、数字、点或下划线组成<br>
                    2）长度为3~20个字符<br>
                    3）中间不可以出现空格符、单引号、双引号、减号、逗号等非法字符<br>
                    4）system，admin是系统的保留账号<br>
                  </span>
                </div>
              </div>
              {{# if(!d.editType){ }}
              <div class="layui-form-item">
                <label class="layui-form-label">密码:</label>
                <div class="layui-input-block">
                  <input type="password" name="passWord" lay-verify="pass" placeholder="请输入" autocomplete="new-password" class="layui-input">
                  <span class="bitianspan">必填</span>
                  <span style="">（最少6个字符）</span>
                </div>
              </div>
              <div class="layui-form-item">
                <label class="layui-form-label">确认密码:</label>
                <div class="layui-input-block">
                  <input type="password" name="passWord2" lay-verify="pwd2" placeholder="请输入" autocomplete="off" class="layui-input">
                  <span class="bitianspan">必填</span>
                </div>
              </div>
              {{# } }}
              <div class="layui-form-item">
                <label class="layui-form-label">电子邮箱:</label>
                <div class="layui-input-block">
                  <input type="text" name="email" lay-verify="email" placeholder="请输入" autocomplete="off" class="layui-input">
                  <span class="bitianspan">必填</span>
                </div>
              </div>
              <div class="layui-form-item">
                <label class="layui-form-label">真实姓名:</label>
                <div class="layui-input-block">
                  <input type="text" name="trueName" placeholder="请输入" autocomplete="off" class="layui-input">
                </div>
              </div>
              <div class="layui-form-item">
                <label class="layui-form-label">详细地址:</label>
                <div class="layui-input-block">
                  <input type="text" name="address" placeholder="请输入" autocomplete="off" class="layui-input">
                </div>
              </div>
              <div class="layui-form-item">
                <label class="layui-form-label">联系电话:</label>
                <div class="layui-input-block">
                  <input type="text" name="tellPhone" placeholder="请输入" autocomplete="off" class="layui-input">
                </div>
              </div>
              <div class="layui-form-item">
                <label class="layui-form-label">手机号码:</label>
                <div class="layui-input-block">
                  <input type="text" name="mobile" placeholder="请输入" autocomplete="off" class="layui-input">
                </div>
              </div>
              <div class="layui-form-item">
                <label class="layui-form-label">上级领导:</label>
                <div class="layui-input-block">
                  <input type="text" name="" placeholder="请输入" autocomplete="off" class="layui-input">
                </div>
              </div>
              <div class="layui-inline">
                <label class="layui-form-label">创建者</label>
                <div class="layui-input-block">
                  <input type="text" name="CRUSER" placeholder="请输入" autocomplete="off" class="layui-input">
                </div>
              </div>
              <input hidden="hidden" name="id">
              <input hidden="hidden" name="sign" value="0">
            </div>
          </div>
      </div>
      <!--<div class="layui-tab-item">
        <div class="h100">
          <div class="title">
            <form class="layui-form">
              <div class="layui-form-item" style="margin: 25px 0 0 30px">
                <label  class="layui-form-label" >选择组织：</label>
                <div class="layui-input-block" style="width: 280px;">
                  <input type="text" class="layui-input" readonly id="input">
                </div>
              </div>
            </form>
          </div>
          <div class="content" style="margin: 10px 0 15px 55px; width: 530px;height: 430px; border: 1px solid rgb(208, 208, 208)">
            <ul id="treeDemo" class="ztree" style=' height: 410px;width:520px; '></ul>
          </div>
        </div>
      </div>
      <div class="layui-tab-item">
        <form class="layui-form" id="form">
          <div class="layui-form-item" style="margin: 25px 0 0 30px">
            <label  class="layui-form-label" >选择站点：</label>
            <div class="layui-input-block" style="width: 380px;">
              <select name="" id="">
                <option value="0" selected disabled hidden>所有站点</option>
                <option value="1">中科院档案馆</option>
                <option value="2">中科聚网信息技术有限公司</option>
              </select>
            </div>
          </div>
        </form>
        <div  class="demo-transfer sysRole" style="margin: 20px 0 15px 50px;">

        </div>
      </div>

      <div class="layui-tab-item">
        <div  class="demo-transfer sysRole" style="margin: 20px 0 15px 50px;">

        </div>
      </div>
      <div class="layui-tab-item">
          <div class="h100">
            <p style="margin: 30px 0 15px 40px">用户的文档查看级别：对应与文档的密级，主要是用于文档的分密级管理。</p>
            <p style="margin-left: 40px">
              用户在可以查看文档列表的栏目下，可以查看到的文档：<br>

              1）所有的密级值为0的文档<br>

              2）密级值大于等于用户文档查看级别对应的密级值的文档
            </p>
            <form class="layui-form" style="margin: 30px 0 30px 40px;">
              <div class="layui-form-item">
                <label class="layui-form-label" style="padding: 9px 0;width: 100px; text-align: left">设置查看级别：</label>
                <div class="layui-inline">
                  <input type="radio" name="sex"  title="普通">
                </div>
                <div class="layui-inline">
                  <input type="radio" name="sex"  title="秘密">
                </div>
                <div class="layui-inline">
                  <input type="radio" name="sex"  title="机密">
                </div>
                <div class="layui-inline">
                  <input type="radio" name="sex"  title="绝密">
                </div>
              </div>
            </form>
          </div>
      </div>-->

      <div class="button-bar">
        <button class="layui-btn" lay-submit lay-filter="addUser">确认</button>
        <button class="layui-btn" type="button" data-type="close">取消</button>
      </div>
    </div>
  </div>
  </form>
</script>

<script type="text/html" id="uploadTemplate">
  <div class="layui-upload-drag" id="test10">
    <i class="layui-icon"></i>
    <p>点击上传，或将文件拖拽到此处</p>
  </div>
</script>

<!--弹出层模板（删除）-->
<script type="text/html"  id="delTableTemplate">
  <br><p>&emsp;&emsp;是否删除数据</p>
  <input hidden="hidden" value="{{d.ids}}">
</script>
<!--注销-->
<script type="text/html"  id="setStatus">
  <br><p>&emsp;&emsp;<span id="tempStatus"></span></p>
  <input hidden="hidden" value="{{d.ids}}">
</script>

<script>
    function  getGroup() {
        ajax("/manage/group/tree","post",{}).then(data=>{
              data.obj.forEach(function(item){
                  $("#orgs").append("<option value='"+item.id+"'>"+item.name+"</option>");

              })
        layui.form.render()
        })

    }
    getGroup();
    function  getRole() {
        ajax("/manage/role/tree","post",{}).then(data=>{
        data.obj.forEach(function(item){
            $("#role").append("<option value='"+item.id+"'>"+item.name+"</option>");

        })
        layui.form.render()
    })

    }
    getRole();
</script>
<script>
  var url = "/manage/user";
  var baseOrder = [];
  var tempSize = 15;
</script>

<!--layui-->
<script>
//    getTreeData();
  layui.form.on("submit(addUser)",function(data){
    var thisurl = url;
    var type = "post";
    var msg = "添加失败";
    if(data.field.id){
      thisurl += "/" +data.field.id;
      type = "put";
      msg = "修改成功";

      var getData = layui.transfer.getData('key123'); //获取右侧数据
      layer.alert(JSON.stringify(getData));

    }
    ajax(thisurl,type,JSON.stringify(data.field)).then(res=>{
      if(res.success){
          layer.closeAll();
          doList(1,{});
      }else{
          res.msg = msg;
          layer.alert(res.msg)
      }
    }).catch(res=>{
    })
    return false;
  })

  layui.form.on("submit(LAY-user-back-search)",function(data){

    doList(1,data.field);
    return false;
  })

  //渲染数据到table
  function setTableData(data) {
    var temp1 = "id";
    var temp2 ="asc";
    if(baseOrder.length>0){
      temp1 = baseOrder[0].key;
      if(baseOrder[0].value==true){
        temp2 = "asc";
      }else{
        temp2 = "desc"
      }
    }
      layui.use('table', function(){
        var table = layui.table;
        table.render({
          elem: '#demo'
          ,data:data.records
          // ,toolbar: '#toolbarDemo'
        ,limit:15
        ,cols: [[
          {type:'checkbox'}
          ,{type:'numbers', width:'90', title: '序号',align: "right"}
          ,{field:'name', width:'220', title: '用户名',align:"left"}
          ,{field:'trueName', width:'135', title: '真实姓名',align:"left"}
          ,{field:'status', width:'120', title: '用户状态',templet:"#state",align:"left"}
          ,{field:'groupName', width:'220', title: '所属组织',align:"left"}
          ,{field:'roleName', width:'210', title: '所属角色',align:"left"}
          ,{field:'regTime', width:'203', title: '开通时间',align: 'left'}
          ,{field:'crUser',  title: '创建人',width:150,align: 'left'}
          ,{field:'', width:'201',title: '权限管理' ,align: 'center', toolbar: '#limitBar',align:"left"}
          ,{field:'', width:'180', title: '操作',toolbar: '#barDemo',align:"left"}
        ]]
      });
    });
    page(data.total,data.current,tempSize);
  }

  var settingss = {
      data: {
          simpleData: {
              enable: true,  //true 、 false 分别表示 使用 、 不使用 简单数据模式
              idKey: "id",  //节点数据中保存唯一标识的属性名称
              pIdKey: "parentId",    //节点数据中保存其父节点唯一标识的属性名称
              rootPId: -1  //用于修正根节点父节点数据，即 pIdKey 指定的属性值
          }
      },
      view: { showLine: false,showIcon:true },
      callback: {
          onClick: zTreeOnClick
      }
  };
  function zTreeOnClick(event, treeId, treeNode) {
      $("#input").val(treeNode.name);
  };
  //渲染树结构
  function showTree(data) {
      zTreeObj = $.fn.zTree.init($("#treeDemo"), settingss, data); //初始化树
      zTreeObj.expandAll(true);    //true 节点全部展开、false节点收缩
  }
  //设置弹出层数据（新增，查看，修改）
  function setOpenData(data,type) {
    layui.layer.open({
      type: 1,
      title: "添加用户",
      area:['700px','650px'],
      anim: 2,
      content: '<div id="table_data" class="userForm"></div>',
    });

    setTpl("tableDataTemplate","table_data",data);
      var url = "/manage/group/tree";
      ajax(url,"post",{}).then(function (res) {
          for(var i in res.obj){
              if(res.obj[i].parentId == 0){
                  res.obj[i].icon = "img/u5548.png";
              }else{
                  res.obj[i].icon = "img/u5554.png";
              }
          }
         if(res.success){
             showTree(res.obj);
         }

      }).catch(err=>{})


    layui.form.val('editForm', data);
    getRole(data.id);
  }

  layui.form.verify({
    pass: [
      /^[\S]{6,16}$/,
      '密码必须6到16位，且不能出现空格'
    ],
    pwd2: function (value) {
      var pwd1 = $("input[name=passWord]").val();
      if (pwd1 != value) {
        return "两次密码输入不一致，请重新输入"
      }
    },
      userName:[
          /^[0-9a-zA-Z_]{1,}$/,
          '用户名格式不正确'
      ]

  });

  //监听操作列工具条
  layui.table.on('tool(demo)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
    var data = obj.data; //获得当前行数据
    var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
    var tr = obj.tr; //获得当前行 tr 的DOM对象

    if(layEvent === 'detail'){ //查看
      setOpenData(data,0);
    } else if(layEvent === 'del'){ //删除
      layer.alert("确定删除:["+data.name+"]",function(){
        doDeleteByIds([data.id]);
      })
    } else if(layEvent === 'edit'){ //编辑
      data.editType = 1;
      setOpenData(data,1);
    }else if(layEvent=='limit'){//权限
        setLimit(data.id,data.name,0);
    }
  });

</script>

<script>
  function del(){
    var data = checkChecked('demo');
    if(data){
      doDeleteByIds(data);
    }
  }
  //根据ids批量删除
  function doDeleteByIds(data) {
    ajax(url+"/delByIds","post",JSON.stringify(data)).then(res=>{
        res.msg="删除失败";
      if(res.success){
          doList(1,{});
          layer.closeAll();
      }else{
          layer.alert(res.msg);
      }
    }).catch(res=>{

    })
  }
  function add(){
    setOpenData({},2);
  }
  //条件列表查询
  function doList(current,entity) {
    var sortProps = [];
    var data={};
    data.pager = {current:current,size:tempSize};
    data.pager.sortProps = sortProps;
    entity.sign = 0;
    data.entity = entity;
    ajax(url+"/list","post",JSON.stringify(data)).then(res=>{
      setTableData(res.obj);
    }).catch(res=>{

    })
  }
  //获取角色
  function getRole(id){
    ajax("/manage/roleUser/getRole","post",{userId:id}).then(data=>{
      //定义标题及数据源
      layui.transfer.render({
        elem: '.sysRole'
        ,parseData: function(res){
          return {
            "value": res.id //数据值
            ,"title": res.name //数据标题
          }
        }
        ,title: ['可选系统级角色', '已有系统级角色']  //自定义标题
        ,data: data.obj.allRoles
        ,height: 500 //定义高度
        ,value: data.obj.userRole
        ,id: "key123"
      })
    })
  }
</script>

<script>
  $(function(){
    doList(1,{});
    $('#searchButton').click(function() {
      doList(1,{});
    })
    layui.form.render();
  });
  layui.use('layer', function() { //独立版的layer无需执行这一句
      var $ = layui.jquery, layer = layui.layer; //独立版的layer无需执行这一句
  })
</script>
<script id="img" type="text/html">

  {{#  if(d.types=== "1"){ }}
  <div style="text-align: left;"><img src="img/u5554.png" alt="">&nbsp;&nbsp;{{d.name}}</div>
  {{#  } else if((d.types=== "2")){ }}
  <div style="text-align: left;">&nbsp;&nbsp;<img src="img/u2615.png" alt="">&nbsp;&nbsp;{{d.name}}</div>
  {{#  } else { }}
  <div style="text-align: left;"><img src="img/u2628.png" alt="" style="margin-left: 20px;">&nbsp;&nbsp;{{d.name}}</div>
  {{#  } }}>
</script>
<script type="text/html" id="state">
  {{#  if(d.status=== 0){ }}
  <div>已开通</div>
  {{#  } else { }}
  <div>未开通</div>
  {{#  } }}>
</script>

