<title>互联网用户</title>

<style>
  .userForm .layui-tab{margin:0;}
  .userForm .layui-tab-title li{padding:0 35px;background-color: rgba(248, 248, 248, 1);}
  .userForm .layui-card{    width: 90%; margin: auto;}
  .userForm .layui-input{    width: 70%; float:left;}
  .userForm .layui-form-item{    margin-bottom: 10px;}
  .userForm .tipspan{font-size: 10px; line-height: 15px;}
  .userForm .button-bar{text-align: center;}
  .userForm .bitianspan {
    height: 40px;
    line-height: 40px;
    margin-left: 20px;
    color: #FF6600;
  }
  .layui-card-header.layuiadmin-card-header-auto{padding-top:10px;padding-bottom: 10px;}
  #temp .layui-table-view {width: 453px;}
  .right{background: url("./img/u6237.png") no-repeat;display: inline-block;width: 16px;height: 16px;}
  .err{background: url("./img/u6239.png") no-repeat;width: 16px;height: 16px;display: inline-block;}
  .layui-layer-iframe .layui-layer-btn, .layui-layer-page .layui-layer-btn{padding-top: 0}
  .layui-form-radio{padding: 0;margin: 0;margin-left: 10px;}
  th .layui-table-cell{text-align: center}
</style>

<div class="layui-card layadmin-header">
  <div class="layui-breadcrumb" lay-filter="breadcrumb">
    <a lay-href="">主页</a>
    <a><cite>用户</cite></a>
    <a><cite>互联网用户</cite></a>
  </div>
</div>

<div class="layui-fluid">
  <div class="layui-card h100">
    <div class="layui-form layui-card-header layuiadmin-card-header-auto" lay-filter="layadmin-useradmin-formlist">
      <form class="layui-form">
        <div class="layui-form-item">
          <div class="layui-inline">
            <label class="layui-form-label">ID</label>
            <div class="layui-input-block">
              <input type="text" name="id" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
          </div>
          <div class="layui-inline">
            <label class="layui-form-label">用户名</label>
            <div class="layui-input-block">
              <input type="text" name="name" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
          </div>
          <div class="layui-inline">
            <label class="layui-form-label">邮箱</label>
            <div class="layui-input-block">
              <input type="text" name="email" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
          </div>
          <div class="layui-inline">
            <label class="layui-form-label">性别</label>
            <div class="layui-input-block">
              <select name="sex">
                <option value="" selected="selected">不限</option>
                <option value="男">男</option>
                <option value="女">女</option>
              </select>
            </div>
          </div>
          <div class="layui-inline">
            <button class="layui-btn layuiadmin-btn-admin" lay-submit lay-filter="LAY-user-back-search">
              <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
            </button>
          </div>
        </div>
      </form>
    </div>

    <div class="layui-card-body">
      <div style="padding-bottom: 10px;">
        <button class="layui-btn layuiadmin-btn-admin" id="addUser" data-type="add">添加互联网用户</button>
        <button class="layui-btn layuiadmin-btn-admin" data-type="del">删除互联网用户</button>
      </div>
      <div style="height: 630px;">
        <table id="demo" lay-filter="demo"></table>
      </div>
      <div id="page"></div>
      <script type="text/html" id="buttonTpl">
        {{#  if(d.check == true){ }}
        <button class="layui-btn layui-btn-xs">已审核</button>
        {{#  } else { }}
        <button class="layui-btn layui-btn-primary layui-btn-xs">未审核</button>
        {{#  } }}
      </script>
      <script type="text/html" id="table-useradmin-admin">
        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
        {{#  if(d.role == '超级管理员'){ }}
        <a class="layui-btn layui-btn-disabled layui-btn-xs"><i class="layui-icon layui-icon-delete"></i>删除</a>
        {{#  } else { }}
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</a>
        {{#  } }}
      </script>
    </div>
  </div>
</div>

<!--表头工具模板-->
<script type="text/html" id="toolbarDemo">
  <div class="layui-btn-container">
    <button class="layui-btn layui-btn-sm" lay-event="add">添加</button>
    <button class="layui-btn layui-btn-sm" lay-event="delete">删除</button>
    <button class="layui-btn layui-btn-sm" lay-event="organ">添加组织</button>
    <button class="layui-btn layui-btn-sm" lay-event="role">添加角色</button>
    <!--<button class="layui-btn layui-btn-sm" lay-event="limit">添加权限</button>-->
    <button class="layui-btn layui-btn-sm" lay-event="open">开通</button>
    <button class="layui-btn layui-btn-sm" lay-event="logout">注销</button>
    <!--<button class="layui-btn layui-btn-sm" lay-event="import">批量导入</button>-->
  </div>
</script>

<!--操作列模板-->
<script type="text/html" id="barDemo">
  <!--<a class="layui-btn layui-btn-xs" lay-event="limit">授权</a>
  <a class="layui-btn layui-btn-xs" lay-event="detail">查看</a>-->
  <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>


<!--弹出层模板（新增，查看，编辑）-->
<script type="text/html"  id="tableDataTemplate">
  <div class="layui-tab-content">
    <div class="layui-tab-item layui-show">
      <form class="layui-form" lay-filter="editForm">
        <div class="layui-card">
          <div class="layui-card-body">
            <div class="layui-form-item">
              <label class="layui-form-label">用户名:</label>
              <div class="layui-input-block">
                <input type="text" name="name" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">手机号码:</label>
              <div class="layui-input-block">
                <input type="text" name="mobile" lay-verify="phone" placeholder="请输入" autocomplete="off" class="layui-input">
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">电子邮箱:</label>
              <div class="layui-input-block">
                <input type="text" name="email" lay-verify="email" placeholder="请输入" autocomplete="off" class="layui-input">
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">头像:</label>
              <div class="layui-upload" style="float:left;">
                <input type="hidden" class="layui-upload-img" name="headUrl"  >
                <img id="demo1" width="92px" height="92px">
                <button type="button" class="layui-btn" id="uploadHead" style="float: right;margin-top: 55px; margin-left: 5px">上传图片</button>
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">选择性别:</label>
              <div class="layui-input-block">
                <input type="radio" name="sex" value="男" checked="checked">男
                <input type="radio" name="sex" value="女">女
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label">创建者</label>
              <div class="layui-input-block">
                <input type="text" name="CRUSER" placeholder="请输入" autocomplete="off" class="layui-input">
              </div>
            </div>
            <input hidden="hidden" name="id">
            <input hidden="hidden" name="sign" value="3">
            <input hidden="hidden" name="passWord" value="123456">
            <div class="button-bar">
              <button class="layui-btn" lay-submit lay-filter="addUser">确认</button>
              <button class="layui-btn" type="button" data-type="close">取消</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</script>

<script type="text/html" id="uploadTemplate">
  <div class="layui-upload-drag" id="test10">
    <i class="layui-icon"></i>
    <p>点击上传，或将文件拖拽到此处</p>
  </div>
</script>

<!--弹出层模板（删除）-->
<script type="text/html"  id="delTableTemplate">
  <br><p>&emsp;&emsp;是否删除数据</p>
  <input hidden="hidden" value="{{d.ids}}">
</script>
<!--注销-->
<script type="text/html"  id="setStatus">
  <br><p>&emsp;&emsp;<span id="tempStatus"></span></p>
  <input hidden="hidden" value="{{d.ids}}">
</script>
<!--注销-->
<script type="text/html"  id="headImgTpl">
  <img src="{{d.headUrl}}" width="20" height="20">
</script>

<script>
    var url = "/manage/user";
    // var url = "/manage/user";
    var baseOrder = [];
    var tempSize = 15;
    var name=""
</script>
<script>
    layui.form.on("submit(addUser)",function(data){
        var thisurl = url;
        var type = "post";
        if(data.field.id){
            thisurl += "/" +data.field.id;
            type = "put";
        }

        ajax(thisurl,type,JSON.stringify(data.field)).then(res=>{
          layer.closeAll();
          if(!res.success) {
            layer.alert(res.msg);
          }
          doList(1, {});
        })
        return false;
    })

    layui.form.on("submit(LAY-user-back-search)",function(data){
        doList(1,data.field);
        return false;
    })

    //渲染数据到table
    function setTableData(data) {
        var temp1 = "id";
        var temp2 ="asc";
        if(baseOrder.length>0){
            temp1 = baseOrder[0].key;
            if(baseOrder[0].value==true){
                temp2 = "asc";
            }else{
                temp2 = "desc"
            }
        }
        layui.use('table', function(){
            var table = layui.table;
            table.render({
                elem: '#demo'
                ,data:data.records
                // ,toolbar: '#toolbarDemo'
                ,limit:15
                ,cols: [[
                    {type:'checkbox'}
                    ,{field:'id',title: 'ID',align: 'right'}
                    ,{field:'name', title: '用户名',align: 'left'}
                    ,{field:'headUrl', title: '头像',align: 'center',templet:"#headImgTpl"}
                    ,{field:'mobile', title: '手机',align: 'left'}
                    ,{field:'email', title: '邮箱',align: 'left'}
                    ,{field:'sex', title: '性别',align: 'left'}
                    // ,{field:'loginIp', width:'178', title: 'IP',align: 'right'}
                    ,{field:'regTime',  title: '加入时间',align: 'left'}
                    ,{field:'crUser',  title: '创建人',align: 'left'}
                    ,{field:'',title: '权限管理' ,align: 'left',templet:"#right"}
                    ,{field:'', title: '操作',toolbar: '#barDemo',align: 'left'}
                ]]
            });
        });
        page(data.total,data.current,tempSize);
    }

    //设置弹出层数据（新增，查看，修改）
    function setOpenData(data) {
        console.log(data);
        var editType = data.id?"修改":"新建";
        layui.layer.open({
            type: 1,
            title: editType+"互联网用户",
            area:['700px','650px'],
            anim: 2,
            content: '<div id="table_data" class="userForm"></div>',
        });
        layui.laytpl($("#tableDataTemplate").html()).render(data, function(html){
            $("#table_data").html(html)
            layui.form.val('editForm', data);
            //普通图片上传
            layui.upload.render({
                elem: '#uploadHead'
                ,url: url+'/importHead'
                ,before: function(obj){
                    //预读本地文件示例，不支持ie8
                    obj.preview(function(index, file, result){
                        $('#demo1').attr('src', result); //图片链接（base64）
                    });
                }
                ,done: function(res){
                    //如果上传失败
                    if(res.code > 0){
                        return layer.msg('上传失败');
                    }
                    // var url=res.obj.substring(res.obj.lastIndexOf("\\")+1,res.obj.length);
                    $("[name=headUrl]").val(res.obj)


                }
            });
        });
    }
    layui.form.verify({
        pass: [
            /^[\S]{6,16}$/,
            '密码必须6到16位，且不能出现空格'
        ],
        pwd2: function (value) {
            var pwd1 = $("input[name=passWord]").val();
            if (pwd1 != value) {
                return "两次密码输入不一致，请重新输入"
            }
        }

    });

    //监听操作列工具条
    layui.table.on('tool(demo)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
        var data = obj.data; //获得当前行数据
        var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
        var tr = obj.tr; //获得当前行 tr 的DOM对象

        if(layEvent === 'detail'){ //查看
            setOpenData(data,0);
        } else if(layEvent === 'del'){ //删除
            layer.alert("确定删除:["+data.name+"]",function(){
                doDeleteByIds([data.id]);
            })
        } else if(layEvent === 'edit'){ //编辑
            data.editType = 1;
            setOpenData(data,1);
        }else if(layEvent=='limit'){//权限
            setItLimit(data.id,data.name);
        }
    });

    layui.form.on('submit(addItLimit)', function(data){
      var arr=[];
      $("#menuLimit input:checkbox:checked").each(function(){
        arr.push({
          objId:data.field.id,
          objType:3,

          rightValue:$(this).val().split(";")[1],
          oprId:$(this).val().split(";")[0],
          oprIdType:3
        });
      })
      ajax("/manage/limitRelation/setLimit","post",JSON.stringify(arr)).then(function (res) {
        layer.closeAll();
      })
      return false;
    });

</script>

<script>
    function del(){
        var data = checkChecked('demo');
        if(data){
            doDeleteByIds(data);
        }
    }
    //根据ids批量删除
    function doDeleteByIds(data) {
        ajax(url+"/delByIds","post",JSON.stringify(data)).then(res=>{
            if(res.success){
            doList(1,{});
            layer.closeAll();
        }
    }).catch(res=>{

        })
    }
    function add(){
        setOpenData({});
    }
    //条件列表查询
    function doList(current,entity) {
        var sortProps = [];
        var data={};
        data.pager = {current:current,size:tempSize};
        data.pager.sortProps = sortProps;
        entity.sign = 3;
        data.entity = entity;
        ajax(url+"/list","post",JSON.stringify(data)).then(res=>{
          setTableData(res.obj);
        })
      }

</script>

<script>
    var itUserObj={};
    function getItLimit(id){
      ajax("/manage/limitRelation/userPermission","post",JSON.stringify(id)).then(function (data) {
        getMenuDate(data.obj);
      })
    }

    $(function(){
        doList(1,{});
        $('#searchButton').click(function() {
            doList(1,{});
        })
        layui.form.render();
    });

    function  setItLimit(id,name) {
        layer.open({
            type: 1
            , title: '权限管理'
            , area: ['540px', '617px']
            , shade: 0.3
            , maxmin: false
            , content: "<div id='form4'></div>"
        });
        layui.laytpl($("#temp1").html()).render({id:id,name:name}, function (html) {
            $("#form4").html(html);
            layui.form.render();
        })
        $("#user").text(name);
        getItLimit(id);
    }
</script>
<script type="text/html" id="right">
  <div class="layui-btn-container">
    <button class="layui-btn layui-btn-primary layui-btn-xs" lay-event="limit">查看</button>
    <button class="layui-btn layui-btn-primary layui-btn-xs" lay-event="limit">设置</button>
  </div>
</script>
<script id="temp1" type="text/html">
  <form class="layui-form" lay-filter="limitForm" id="menuLimit">
    <div class="h100" style="padding: 20px 0 0 40px" id="temp">
      <p><i class="layui-icon layui-icon-user"></i>&nbsp;&nbsp;<span id="user">{{d.name}}</span></p>
      <table class="layui-hide" id="menuTable"></table>
    </div>
    <div class="button-bar">
      <button class="layui-btn" lay-submit lay-filter="addItLimit">确认</button>
      <button class="layui-btn" type="button" data-type="close">取消</button>
    </div>
    <input type="hidden" name="id" value="{{d.id}}">
  </form>
</script>
<script id="operations" type="text/html">
  {{#  if(d.operation === "1"){ }}
  <span class="right"></span>
  {{#  } else{ }}
  <span></span>
  {{#  } }}
</script>